
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>郑大侠的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="DempeZheng">
    

    
    <meta name="description" content="請更固執，將自己謀生與擅長的事情做到最好">
<meta property="og:type" content="website">
<meta property="og:title" content="郑大侠的博客">
<meta property="og:url" content="http://code.zhizus.com/index.html">
<meta property="og:site_name" content="郑大侠的博客">
<meta property="og:description" content="請更固執，將自己謀生與擅長的事情做到最好">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="郑大侠的博客">
<meta name="twitter:description" content="請更固執，將自己謀生與擅長的事情做到最好">

    
    <link rel="alternative" href="/atom.xml" title="郑大侠的博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="郑大侠的博客" title="郑大侠的博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="郑大侠的博客">郑大侠的博客</a></h1>
				<h2 class="blog-motto">DempeZheng&#39;S Blog</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:code.zhizus.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-11-05-guava-cache.html" title="Guava Cache 分析" itemprop="url">Guava Cache 分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-11-04T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-11-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Guava-Cache-分析"><a href="#Guava-Cache-分析" class="headerlink" title="Guava Cache 分析"></a>Guava Cache 分析</h2><h3 id="guava的单线程回源"><a href="#guava的单线程回源" class="headerlink" title="guava的单线程回源"></a>guava的单线程回源</h3><p>缓存的更新有两种方法:</p>
<ul>
<li>被动更新：先从缓存获取，没有则回源获取，再更新缓存；</li>
<li>主动更新：发现数据改变后直接更新缓存（在分布式场景下，不容易实现）</li>
</ul>
<p>在高并发环境，被动回源是需要注意的。<br>问题：高并发场景下，大量请求在同一时间回源，大量的请求同一时间穿透到后端，容易引起后端服务崩溃（也容易引起并发问题）。</p>
<p>guava cache解决办法：<br>guava cache保证单线程回源，对于同一个key，只让一个请求回源load，其他线程阻塞等待结果。同时，在Guava里可以通过配置expireAfterAccess/expireAfterWrite设定key的过期时间，key过期后就单线程回源加载并放回缓存。</p>
<p>这样通过Guava Cache简简单单就较为安全地实现了缓存的被动更新操作。</p>
<p>但是如果对于同一时间大量不同的key同时过期，造成大量不同的key同时回源，这种怎么解决呢？</p>
<blockquote>
<p>guava cache实现类似ConcurrentHashMap，维护segment数组，每个segment独享一个锁，ConcurrentHashMap是通过这种机制来实现分段锁，ConcurrentHashMap默认分了16个segment；<br>guava Cache默认是4个segment，故guava cache的并发级别默认是4个，也就是说默认情况下，即便是大量不同的key同时过期，最多只也有4个线程并发回源，理论上不会给后端造成过大的压力。</p>
</blockquote>
<h3 id="guava-refresh和expire刷新机制"><a href="#guava-refresh和expire刷新机制" class="headerlink" title="guava refresh和expire刷新机制"></a>guava refresh和expire刷新机制</h3><ul>
<li>expireAfterAccess: 当缓存项在指定的时间段内没有被读或写就会被回收。</li>
<li>expireAfterWrite：当缓存项在指定的时间段内没有更新就会被回收。</li>
<li>refreshAfterWrite：当缓存项上一次更新操作之后的多久会被刷新。</li>
</ul>
<p>仅仅使用 expireAfterWrite或者expireAfterAccess就可以实现缓存定时过期，但是频繁的过期会造成频繁的单线程回源，然而guava cache回源的时候会独占一个segment的锁，对于同一个segment的其他的读操作 处于loading状态的则会继续等待，value expire或者为null的key则会阻塞等待segment的锁。</p>
<p> expireAfterWrite或者expireAfterAccess的实现在数据回源的时候会让请求block住，以获取最新的值。数据实时性保证的较好，但是阻塞住请求对于一些响应要求严苛的业务可能是没办法接受的。那有没有解决的办法呢？</p>
<p>我们且看refreshAfterWrite：</p>
<p>refreshAfterWrite通过定时刷新可以让缓存项保持可用。缓存项只有在被检索时才会真正刷新（如果CacheLoader.refresh实现为异步，那么检索不会被刷新拖慢）。也是保证同一个segment的单线程回源，但是与expireAfterWrite不同的是：其他线程访问loading状态的key时，仅仅稍微等一会，没有等到就返回旧值，整个请求就比较平滑。<br>与此同时，也引入了一个问题，refreshAfterWrite策略下，如果一个key长期没有被访问，就有可能会访问到很久之前的旧值。例如refreshAfterWrite(5),5s刷新一次，如果1min内，这个key都没有被访问，那么1min之后访问这个key，仍然有可能访问到旧数据，尽管我们设置了5s刷新一次。（guava cache并没单独的线程来处理刷新的逻辑，而是通过读操作来触发清理工作）</p>
<p>对于这个问题有没有这种的办法呢？<br>guava cache支持我们同时使用expireAfterWrite&amp;refreshAfterWrite，我们既可以通过组合的策略既保证性能，又保证不要读取到太旧的数据。<br>比如我们有需求：要求请求必须平滑，而且不能读到5s之前的旧数据。</p>
<p>我们可以如下设置来满足需求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;String, String&gt; cache;</div><div class="line">   cache = CacheBuilder</div><div class="line">           .newBuilder()</div><div class="line">           .refreshAfterWrite(4L, TimeUnit.SECONDS)</div><div class="line">           .expireAfterWrite(5L, TimeUnit.SECONDS)</div><div class="line">           .build(loader);</div></pre></td></tr></table></figure>
<p> <code>expireAfterWrite(5L, TimeUnit.SECONDS)</code>能保证不会读到5s之前的旧数据，<code>refreshAfterWrite(4L, TimeUnit.SECONDS)</code>能保证大部分请求都在4s左右被刷新，小部分访问量较少的在5s的时候通过expireAfterWrite策略重新被回源。</p>
<h3 id="guava后台异步刷新"><a href="#guava后台异步刷新" class="headerlink" title="guava后台异步刷新"></a>guava后台异步刷新</h3><p>refreshAfterWrite的刷新调用的是reload，reload的默认实现是在当前线程里面reload，也会造成一些卡顿，如果希望异步reload，需要重载这个方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@GwtIncompatible // Futures</div><div class="line"> public ListenableFuture&lt;V&gt; reload(K key, V oldValue) throws Exception &#123;</div><div class="line">   checkNotNull(key);</div><div class="line">   checkNotNull(oldValue);</div><div class="line">   return Futures.immediateFuture(load(key));//当前线程调用load，会造成当前线程的卡顿，如果不接受卡顿，需要重载这个方法</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cache/">cache</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-11-05guava-cache-info.html" title="Guava Cache使用示例" itemprop="url">Guava Cache使用示例</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-11-04T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-11-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="guava-cache-usage"><a href="#guava-cache-usage" class="headerlink" title="guava cache usage"></a>guava cache usage</h2><h3 id="1-使用场景"><a href="#1-使用场景" class="headerlink" title="1.使用场景"></a>1.使用场景</h3><blockquote>
<p>缓存在很多场景下都是相当有用的。例如，计算或检索一个值的代价很高，并且对同样的输入需要不止一次获取值的时候，就应当考虑使用缓存。</p>
<p>Guava Cache与ConcurrentMap很相似，但也不完全一样。最基本的区别是ConcurrentMap会一直保存所有添加的元素，直到显式地移除。相对地，Guava Cache为了限制内存占用，通常都设定为自动回收元素。在某些场景下，尽管LoadingCache 不回收元素，它也是很有用的，因为它会自动加载缓存。</p>
</blockquote>
<p>通常来说，Guava Cache适用于：</p>
<ul>
<li>你愿意消耗一些内存空间来提升速度。</li>
<li>你预料到某些键会被查询一次以上。</li>
<li>缓存中存放的数据总量不会超出内存容量。（Guava Cache是单个应用运行时的本地缓存。它不把数据存放到文件或外部服务器。如果这不符合你的需求，请尝试Memcached这类工具）</li>
</ul>
<p>如果你的场景符合上述的每一条，Guava Cache就适合你。</p>
<p>如同范例代码展示的一样，Cache实例通过CacheBuilder生成器模式获取，但是自定义你的缓存才是最有趣的部分。</p>
<p>注：如果你不需要Cache中的特性，使用ConcurrentHashMap有更好的内存效率——但Cache的大多数特性都很难基于旧有的ConcurrentMap复制，甚至根本不可能做到。</p>
<h3 id="2-如何使用Guava-Cache"><a href="#2-如何使用Guava-Cache" class="headerlink" title="2.如何使用Guava Cache"></a>2.如何使用Guava Cache</h3><p>下面我们以一个简单的例子开始，缓存大写的字符串key。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">   public void whenCacheMiss_thenValueIsComputed() throws InterruptedException &#123;</div><div class="line">       CacheLoader&lt;String, String&gt; loader;</div><div class="line">       loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">           // 当guava cache中不存在，则会调用load方法</div><div class="line">           @Override</div><div class="line">           public String load(String key) &#123;</div><div class="line">               return key.toUpperCase();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       LoadingCache&lt;String, String&gt; cache;</div><div class="line">       cache = CacheBuilder</div><div class="line">               .newBuilder()</div><div class="line">               // 写数据1s后重新加载缓存</div><div class="line">               .refreshAfterWrite(1L, TimeUnit.SECONDS)</div><div class="line">               .build(loader);</div><div class="line"></div><div class="line">       assertEquals(0, cache.size());</div><div class="line">       cache.put(&quot;test&quot;, &quot;test&quot;);</div><div class="line">       assertEquals(&quot;test&quot;, cache.getUnchecked(&quot;test&quot;));</div><div class="line">       assertEquals(&quot;HELLO&quot;, cache.getUnchecked(&quot;hello&quot;));</div><div class="line">       assertEquals(2, cache.size());</div><div class="line"></div><div class="line">       TimeUnit.SECONDS.sleep(2);</div><div class="line">       assertEquals(&quot;TEST&quot;, cache.getUnchecked(&quot;test&quot;));</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="3-回收策略"><a href="#3-回收策略" class="headerlink" title="3.回收策略"></a>3.回收策略</h3><p>所有的cache都需要定期remove value，下面我们看看guava cache的回收策略。</p>
<h4 id="3-1-基于容量的回收-Eviction-by-Size"><a href="#3-1-基于容量的回收-Eviction-by-Size" class="headerlink" title="3.1. 基于容量的回收(Eviction by Size)"></a>3.1. 基于容量的回收(Eviction by Size)</h4><p>我们可以通过<code>maximumSize()</code>方法限制cache的size，如果cache达到了最大限制，oldest items 将会被回收。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">   public void whenCacheReachMaxSize_thenEviction() &#123;</div><div class="line">       CacheLoader&lt;String, String&gt; loader;</div><div class="line">       loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public String load(String key) &#123;</div><div class="line">               return key.toUpperCase();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">       LoadingCache&lt;String, String&gt; cache;</div><div class="line">       cache = CacheBuilder.newBuilder().maximumSize(3).build(loader);</div><div class="line"></div><div class="line">       cache.getUnchecked(&quot;first&quot;);</div><div class="line">       cache.getUnchecked(&quot;second&quot;);</div><div class="line">       cache.getUnchecked(&quot;third&quot;);</div><div class="line">       cache.getUnchecked(&quot;forth&quot;);</div><div class="line">       assertEquals(3, cache.size());</div><div class="line">       assertNull(cache.getIfPresent(&quot;first&quot;));</div><div class="line">       assertEquals(&quot;FORTH&quot;, cache.getIfPresent(&quot;forth&quot;));</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>我们也可以限制cache size通过定制<code>weight function</code>，以下为自定义<code>weight function</code>实现的限制cache size 的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">  public void whenCacheReachMaxWeight_thenEviction() &#123;</div><div class="line">      CacheLoader&lt;String, String&gt; loader;</div><div class="line">      loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">          @Override</div><div class="line">          public String load(String key) &#123;</div><div class="line">              return key.toUpperCase();</div><div class="line">          &#125;</div><div class="line">      &#125;;</div><div class="line"></div><div class="line">      Weigher&lt;String, String&gt; weighByLength;</div><div class="line">      weighByLength = new Weigher&lt;String, String&gt;() &#123;</div><div class="line">          @Override</div><div class="line">          public int weigh(String key, String value) &#123;</div><div class="line">              return value.length();</div><div class="line">          &#125;</div><div class="line">      &#125;;</div><div class="line"></div><div class="line">      LoadingCache&lt;String, String&gt; cache;</div><div class="line">      cache = CacheBuilder.newBuilder()</div><div class="line">              .maximumWeight(16)</div><div class="line">              .weigher(weighByLength)</div><div class="line">              .build(loader);</div><div class="line"></div><div class="line">      cache.getUnchecked(&quot;first&quot;);</div><div class="line">      cache.getUnchecked(&quot;second&quot;);</div><div class="line">      cache.getUnchecked(&quot;third&quot;);</div><div class="line">      cache.getUnchecked(&quot;last&quot;);</div><div class="line">      assertEquals(3, cache.size());</div><div class="line">      assertNull(cache.getIfPresent(&quot;first&quot;));</div><div class="line">      assertEquals(&quot;LAST&quot;, cache.getIfPresent(&quot;last&quot;));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h4 id="3-2-定时回收-Eviction-by-Time"><a href="#3-2-定时回收-Eviction-by-Time" class="headerlink" title="3.2. 定时回收(Eviction by Time)"></a>3.2. 定时回收(Eviction by Time)</h4><p>除了通过size来回收记录，我们也可以选择定时回收</p>
<p><code>CacheBuilder</code>提供两种定时回收的方法：</p>
<ul>
<li><code>expireAfterAccess(long, TimeUnit)</code>：缓存项在给定时间内没有被读/写访问，则回收。请注意这种缓存的回收顺序和基于大小回收一样。</li>
<li><code>expireAfterWrite(long, TimeUnit)</code>：缓存项在给定时间内没有被写访问（创建或覆盖），则回收。如果认为缓存数据总是在固定时候后变得陈旧不可用，这种回收方式是可取的。</li>
</ul>
<p>下面代码 将示例<code>expireAfterAccess</code>的用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">   public void whenEntryIdle_thenEviction() throws InterruptedException &#123;</div><div class="line">       CacheLoader&lt;String, String&gt; loader;</div><div class="line">       loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public String load(String key) &#123;</div><div class="line">               return key.toUpperCase();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       LoadingCache&lt;String, String&gt; cache;</div><div class="line">       cache = CacheBuilder.newBuilder()</div><div class="line">               .expireAfterAccess(2, TimeUnit.MILLISECONDS)</div><div class="line">               .build(loader);</div><div class="line"></div><div class="line">       cache.getUnchecked(&quot;hello&quot;);</div><div class="line">       assertEquals(1, cache.size());</div><div class="line"></div><div class="line">       cache.getUnchecked(&quot;hello&quot;);</div><div class="line">       Thread.sleep(300);</div><div class="line"></div><div class="line">       cache.getUnchecked(&quot;test&quot;);</div><div class="line">       assertEquals(1, cache.size());</div><div class="line">       assertNull(cache.getIfPresent(&quot;hello&quot;));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="3-3-基于引用的回收-Reference-based-Eviction"><a href="#3-3-基于引用的回收-Reference-based-Eviction" class="headerlink" title="3.3.基于引用的回收(Reference-based Eviction)"></a>3.3.基于引用的回收(Reference-based Eviction)</h4><p>通过使用弱引用的键、或弱引用的值、或软引用的值，Guava Cache可以把缓存设置为允许垃圾回收：</p>
<ul>
<li>CacheBuilder.weakKeys()：使用弱引用存储键。当键没有其它（强或软）引用时，缓存项可以被垃圾回收。因为垃圾回收仅依赖恒等式（==），使用弱引用键的缓存用==而不是equals比较键。</li>
<li>CacheBuilder.softValues()：使用软引用存储值。软引用只有在响应内存需要时，才按照全局最近最少使用的顺序回收。考虑到使用软引用的性能影响，我们通常建议使用更有性能预测性的缓存大小限定（见上文，基于容量回收）。使用软引用值的缓存同样用==而不是equals比较值。</li>
</ul>
<h4 id="3-4-显式清除"><a href="#3-4-显式清除" class="headerlink" title="3.4.显式清除"></a>3.4.显式清除</h4><p>任何时候，你都可以显式地清除缓存项，而不是等到它被回收：</p>
<ul>
<li>个别清除：<code>Cache.invalidate(key)</code></li>
<li>批量清除：<code>Cache.invalidateAll(keys)</code></li>
<li>清除所有缓存项：<code>Cache.invalidateAll()</code></li>
</ul>
<h3 id="4-移除监听-RemovalNotification"><a href="#4-移除监听-RemovalNotification" class="headerlink" title="4.移除监听(RemovalNotification)"></a>4.移除监听(RemovalNotification)</h3><blockquote>
<p>通过CacheBuilder.removalListener(RemovalListener)，你可以声明一个监听器，以便缓存项被移除时做一些额外操作。缓存项被移除时，RemovalListener会获取移除通知[RemovalNotification]，其中包含移除原因[RemovalCause]、键和值。</p>
</blockquote>
<p><strong>请注意，RemovalListener抛出的任何异常都会在记录到日志后被丢弃[swallowed]。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">   public void whenEntryRemovedFromCache_thenNotify() &#123;</div><div class="line">       CacheLoader&lt;String, String&gt; loader;</div><div class="line">       loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public String load(final String key) &#123;</div><div class="line">               return key.toUpperCase();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       RemovalListener&lt;String, String&gt; listener;</div><div class="line">       listener = new RemovalListener&lt;String, String&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public void onRemoval(RemovalNotification&lt;String, String&gt; n) &#123;</div><div class="line">               if (n.wasEvicted()) &#123;</div><div class="line">                   String cause = n.getCause().name();</div><div class="line">                   assertEquals(RemovalCause.SIZE.toString(), cause);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       LoadingCache&lt;String, String&gt; cache;</div><div class="line">       cache = CacheBuilder.newBuilder()</div><div class="line">               .maximumSize(3)</div><div class="line">               .removalListener(listener)</div><div class="line">               .build(loader);</div><div class="line"></div><div class="line">       cache.getUnchecked(&quot;first&quot;);</div><div class="line">       cache.getUnchecked(&quot;second&quot;);</div><div class="line">       cache.getUnchecked(&quot;third&quot;);</div><div class="line">       cache.getUnchecked(&quot;last&quot;);</div><div class="line">       assertEquals(3, cache.size());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="5-刷新-Refresh-the-Cache"><a href="#5-刷新-Refresh-the-Cache" class="headerlink" title="5.刷新( Refresh the Cache)"></a>5.刷新( Refresh the Cache)</h3><p>刷新和回收不太一样。正如LoadingCache.refresh(K)所声明，刷新表示为键加载新值，这个过程可以是异步的。在刷新操作进行时，缓存仍然可以向其他线程返回旧值，而不像回收操作，读缓存的线程必须等待新值加载完成。</p>
<p>如果刷新过程抛出异常，缓存将保留旧值，而异常会在记录到日志后被丢弃[swallowed]。</p>
<p>重载CacheLoader.reload(K, V)可以扩展刷新时的行为，这个方法允许开发者在计算新值时使用旧的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void cache_reLoad() &#123;</div><div class="line">    CacheLoader&lt;String, String&gt; loader;</div><div class="line">    loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">        @Override</div><div class="line">        public String load(String key) &#123;</div><div class="line">            return key.toUpperCase();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /**</div><div class="line">         * 重写reload方法可以定制自己的reload策略</div><div class="line">         * @param key</div><div class="line">         * @param oldValue</div><div class="line">         * @return</div><div class="line">         * @throws Exception</div><div class="line">         */</div><div class="line">        @Override</div><div class="line">        public ListenableFuture&lt;String&gt; reload(String key, String oldValue) throws Exception &#123;</div><div class="line">            return super.reload(key, oldValue);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    LoadingCache&lt;String, String&gt; cache;</div><div class="line">    cache = CacheBuilder.newBuilder()</div><div class="line">            .build(loader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CacheBuilder.refreshAfterWrite(long, TimeUnit)可以为缓存增加自动定时刷新功能。和expireAfterWrite相反，refreshAfterWrite通过定时刷新可以让缓存项保持可用，但请注意：缓存项只有在被检索时才会真正刷新（如果CacheLoader.refresh实现为异步，那么检索不会被刷新拖慢）。因此，如果你在缓存上同时声明expireAfterWrite和refreshAfterWrite，缓存并不会因为刷新盲目地定时重置，如果缓存项没有被检索，那刷新就不会真的发生，缓存项在过期时间后也变得可以回收。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">   public void whenLiveTimeEnd_thenRefresh() &#123;</div><div class="line">       CacheLoader&lt;String, String&gt; loader;</div><div class="line">       loader = new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public String load(String key) &#123;</div><div class="line">               return key.toUpperCase();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       LoadingCache&lt;String, String&gt; cache;</div><div class="line">       cache = CacheBuilder.newBuilder()</div><div class="line">               .refreshAfterWrite(1, TimeUnit.MINUTES)</div><div class="line">               .build(loader);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="6-处理空值-Handle-null-Values"><a href="#6-处理空值-Handle-null-Values" class="headerlink" title="6. 处理空值(Handle null Values)"></a>6. 处理空值(Handle null Values)</h3><blockquote>
<p>实际上Guava整体设计思想就是拒绝null的，很多地方都会执行com.google.common.base.Preconditions.checkNotNull的检查。 </p>
</blockquote>
<p>By default, Guava Cache will throw exceptions if you try to load a null value – as it doesn’t make any sense to cache a null.</p>
<p>But if null value means something in your code, then you can make good use of the Optional class as in the following example:<br>默认情况guava cache将会抛出异常，如果试图加载null value–因为cache null 是没有任何意义的。<br>但是如果null value 对你的代码而已有一些特殊的含义，你可以尝试用Optional来表达，像下面这个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">    public void whenNullValue_thenOptional() &#123;</div><div class="line">        CacheLoader&lt;String, Optional&lt;String&gt;&gt; loader;</div><div class="line">        loader = new CacheLoader&lt;String, Optional&lt;String&gt;&gt;() &#123;</div><div class="line">            @Override</div><div class="line">            public Optional&lt;String&gt; load(String key) &#123;</div><div class="line">                return Optional.fromNullable(getSuffix(key));</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        LoadingCache&lt;String, Optional&lt;String&gt;&gt; cache;</div><div class="line">        cache = CacheBuilder.newBuilder().build(loader);</div><div class="line"></div><div class="line">        assertEquals(&quot;txt&quot;, cache.getUnchecked(&quot;text.txt&quot;).get());</div><div class="line">        assertFalse(cache.getUnchecked(&quot;hello&quot;).isPresent());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private String getSuffix(final String str) &#123;</div><div class="line">        int lastIndex = str.lastIndexOf(&apos;.&apos;);</div><div class="line">        if (lastIndex == -1) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">        return str.substring(lastIndex + 1);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="7-统计"><a href="#7-统计" class="headerlink" title="7. 统计"></a>7. 统计</h3><p>CacheBuilder.recordStats()用来开启Guava Cache的统计功能。统计打开后，Cache.stats()方法会返回CacheStats对象以提供如下统计信息：</p>
<ul>
<li>hitRate()：缓存命中率；</li>
<li>averageLoadPenalty()：加载新值的平均时间，单位为纳秒；</li>
<li>evictionCount()：缓存项被回收的总数，不包括显式清除。</li>
</ul>
<p>此外，还有其他很多统计信息。这些统计信息对于调整缓存设置是至关重要的，在性能要求高的应用中我们建议密切关注这些数据。</p>
<h3 id="8-Notes"><a href="#8-Notes" class="headerlink" title="8. Notes"></a>8. Notes</h3><p>1.什么时候用get，什么时候用getUnchecked<br>官网文档说：</p>
<blockquote>
<p>. If you have defined a CacheLoader that does not declare any checked exceptions then you can perform cache lookups using getUnchecked(K);<br>however care must be taken not to call getUnchecked on caches whose CacheLoaders declare checked exceptions.</p>
</blockquote>
<p>字面意思是，如果你的CacheLoader没有定义任何checked Exception，那你可以使用getUnchecked。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cache/">cache</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-23-motan-codec.html" title="Motan源码解读-codec" itemprop="url">Motan源码解读-codec</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-22T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>motan的codec负责rpc框架通讯协议的编解码。codec模块是每个rpc必备的模块，一个设计良好的codec关系到rpc框架编解码的性能和对不同协议的扩展。</p>
<p>dubbo支持http,thrift,dubbo,rmi,webservice,redis等等协议，而motan目前仅支持默认motan的协议，所以很多时候我们可能会扩展motan支持自己的协议，那么我们就得从codec入手了（有的时候甚至还会涉及到protocol）。</p>
<p>codec的类图如下：</p>
<p><img src="/images/motan/codec.png" alt="Alt text"></p>
<p>下面 codec interface的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可基于spi扩展</span></div><div class="line"><span class="meta">@Spi</span>(scope=Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Codec</span> </span>&#123;</div><div class="line">	<span class="comment">// channel为motan定义的channel，非netty的channel</span></div><div class="line">	<span class="keyword">byte</span>[] encode(Channel channel, Object message) <span class="keyword">throws</span> IOException;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> channel</div><div class="line">	 * <span class="doctag">@param</span> remoteIp 用来在server端decode request时能获取到client的ip。</div><div class="line">	 * <span class="doctag">@param</span> buffer</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="comment">// 不明白为什么要把remoteIp定义到decode接口里面，channel里面已经包含ip的信息了</span></div><div class="line">	<span class="function">Object <span class="title">decode</span><span class="params">(Channel channel, String remoteIp, <span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractCodec里面实现了创建输入输出流的方法，用来将协议序列化成字节数组或将字节数组反序列化成协议的。（这种方式的性能还没压测，不知道好坏）</p>
<p>如果我们要实现自己的协议，可以仅仅实现codec的方法。</p>
<p>实现AbstractCodec的有三个类</p>
<ul>
<li>DefaultRpcCodec</li>
</ul>
<blockquote>
<p>默认的协议编解码实现</p>
</blockquote>
<ul>
<li>MockDefaultRpcCodec</li>
</ul>
<blockquote>
<p>用于测试的</p>
</blockquote>
<ul>
<li>CompresssRpcCodec</li>
</ul>
<blockquote>
<p>经过压缩的协议编解码实现</p>
</blockquote>
<p>为了不引入复杂性，我们先看DefaultRpcCodec的实现。<br>要知道motan如何对协议编解码，首先我们的非常清楚motan的协议格式。</p>
<p>CompresssRpcCodec这个类的注释中已经有协议各个模块的实现，但是还不够清晰简明，我们先整理一个图。</p>
<h4 id="motan协议格式"><a href="#motan协议格式" class="headerlink" title="motan协议格式"></a>motan协议格式</h4><ul>
<li>header</li>
</ul>
<table style="border-collapse:collapse;border-spacing:0;border-color:#999"><tr><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4;text-align:center" colspan="7">header</th></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">0-15</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">16-23</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">24-31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">32-95</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">96-127</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">magic</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">version</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">extend flag</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">request id</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">body content length</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">魔数</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">协议版本</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">24-28</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">29-30</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>消息id<br></td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>body包长</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">保留</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">event( 可支持4种event，<br>如normal, exception等)</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">0 is request , 1 is response</td></tr></table>


<ul>
<li>request body</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/* </span></div><div class="line">   * &lt;pre&gt;</div><div class="line">* </div><div class="line">* 	 body:</div><div class="line">* </div><div class="line">* 	 byte[] data :  </div><div class="line">* </div><div class="line">* 			serialize(interface_name, method_name, method_param_desc, method_param_value, attachments_size, attachments_value) </div><div class="line">* </div><div class="line">*   method_param_desc:  for_each (string.append(method_param_interface_name))</div><div class="line">* </div><div class="line">*   method_param_value: for_each (method_param_name, method_param_value)</div><div class="line">* </div><div class="line">* 	 attachments_value:  for_each (attachment_name, attachment_value)</div><div class="line">* </div><div class="line">* &lt;/pre&gt;</div><div class="line">   * </div><div class="line">   * @param request</div><div class="line">   * @return</div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">byte</span>[] encodeRequest(Channel channel, Request request) <span class="keyword">throws</span> IOException ;</div></pre></td></tr></table></figure>
<p>encodeRequest方法的注释很清晰的描述了request 的body部分的序列化，对jvm系列的来说非常友好，基本上把调用相关所有能用到的信息都序列化了。</p>
<p>我们可以把请求任何一个请求参数都反序列化java对象。所以motan默认的协议是可以支持方法内参数为java任意对象。<br>但是，<code>对于其他语言就不太友好了</code>。其他语言不太容易序列化java的对象。<br>如果希望更好的支持其他的语言，这个请求参数的类型序列化方式可能有所取舍了。</p>
<ul>
<li>response body</li>
</ul>
<blockquote>
<p><code>serialize (result) or serialize (exception)</code>：motan的response的message对象是通过hession2或者fastjson序列化生成的字节数组，所以这个地方就是一个字节数组（如果需要了解序列化的部分，可以看上篇博客）</p>
</blockquote>
<h4 id="motan协议打包"><a href="#motan协议打包" class="headerlink" title="motan协议打包"></a>motan协议打包</h4><p>协议的打包简单说一下header打包的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] encode(<span class="keyword">byte</span>[] body, <span class="keyword">byte</span> flag, <span class="keyword">long</span> requestId) <span class="keyword">throws</span> IOException &#123;</div><div class="line">      <span class="comment">// 协议1的header占16个字节，先创建一个长度为16的字节数组</span></div><div class="line">      <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[RpcProtocolVersion.VERSION_1.getHeaderLength()];</div><div class="line">      <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 0 - 15 bit : magic</span></div><div class="line">      <span class="comment">// 这个方法实际上是把short类型的magic转成两个字节，打包到header</span></div><div class="line">      ByteUtil.short2bytes(MAGIC, header, offset);</div><div class="line">      offset += <span class="number">2</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 16 - 23 bit : version</span></div><div class="line">      <span class="comment">// 打包version</span></div><div class="line">      header[offset++] = RpcProtocolVersion.VERSION_1.getVersion();</div><div class="line"></div><div class="line">      <span class="comment">// 24 - 31 bit : extend flag</span></div><div class="line">      <span class="comment">// 打包flag</span></div><div class="line">      header[offset++] = flag;</div><div class="line"></div><div class="line">      <span class="comment">// 32 - 95 bit : requestId</span></div><div class="line">      <span class="comment">// 打包requestId</span></div><div class="line">      ByteUtil.long2bytes(requestId, header, offset);</div><div class="line">      offset += <span class="number">8</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 96 - 127 bit : body content length</span></div><div class="line">      <span class="comment">// 打包body包长</span></div><div class="line">      ByteUtil.int2bytes(body.length, header, offset);</div><div class="line"></div><div class="line">      <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[header.length + body.length];</div><div class="line"></div><div class="line">      System.arraycopy(header, <span class="number">0</span>, data, <span class="number">0</span>, header.length);</div><div class="line">      System.arraycopy(body, <span class="number">0</span>, data, header.length, body.length);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> data;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>到这里motan默认的协议基本分析完，但是还没说到CompresssRpcCodec 压缩的编解码，（这个压缩的类跟协议编解码写到一起，分离出来会不会更好[如果我们能确定哪些地方需要压缩]）</p>
<h4 id="motan协议的压缩"><a href="#motan协议的压缩" class="headerlink" title="motan协议的压缩"></a>motan协议的压缩</h4><p>数据压缩也是一个完善的rpc框架必备的功能之一，良好的压缩可以减少网络传输数据大小，节省流量，提升响应速度。</p>
<h5 id="压缩算法比较"><a href="#压缩算法比较" class="headerlink" title="压缩算法比较"></a>压缩算法比较</h5><p>以下是Google几年前发布的一组测试数据（数据有些老了，有人近期做过测试的话希望能共享出来）：</p>
<table style="border-collapse:collapse;border-spacing:0;border-color:#999"><tr><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">Algorithm</th><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">% remaining</th><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">Encoding</th><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">Decoding</th></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">GZIP</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">13.4%</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">21 MB/s</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">118 MB/s</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">LZO</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">20.5%</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">135 MB/s</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">410 MB/s</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">Zippy/Snappy</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">22.2%</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">172 MB/s</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">409 MB/s</td></tr></table>



<p>注：来自《HBase: The Definitive Guide》<br>其中：</p>
<p>1）GZIP的压缩率最高，但是其实CPU密集型的，对CPU的消耗比其他算法要多，压缩和解压速度也慢；</p>
<p>2）LZO的压缩率居中，比GZIP要低一些，但是压缩和解压速度明显要比GZIP快很多，其中解压速度快的更多；</p>
<p>3）Zippy/Snappy的压缩率最低，而压缩和解压速度要稍微比LZO要快一些。</p>
<h4 id="motan中的协议压缩"><a href="#motan中的协议压缩" class="headerlink" title="motan中的协议压缩"></a>motan中的协议压缩</h4><p>motan默认支持的压缩是gzip，这块代码比较杂，不支持扩展，如果要实现自己的压缩方式，得重新实现codec部分（继承defaultRpcCodec，重写部分方法也可以）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 对rpc body进行压缩。</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] compress(<span class="keyword">byte</span>[] org, <span class="keyword">boolean</span> useGzip, <span class="keyword">int</span> minGzSize) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">if</span> (useGzip &amp;&amp; org.length &gt; minGzSize) &#123;</div><div class="line">            ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">            GZIPOutputStream gos = <span class="keyword">new</span> GZIPOutputStream(outputStream);</div><div class="line">            gos.write(org);</div><div class="line">            gos.finish();</div><div class="line">            gos.flush();</div><div class="line">            gos.close();</div><div class="line">            <span class="keyword">byte</span>[] ret = outputStream.toByteArray();</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> org;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>就不一一分析motan这块代码，简单总结一下motan compress：</p>
<p>1）motan压缩的仅仅是rpc 的body部分。header没有压缩的必要。</p>
<p>2）心跳包没有body，不压缩。</p>
<p>3） mingzSize(“mingzSize”, 1000), // 进行gz压缩的最小数据大小。超过此阈值才进行gz压缩</p>
<p>4）usegz(“usegz”, false), // 是否开启gzip压缩，这个可以配置</p>
<p>5）是否开启压缩usegz这个是通过配置来约定的，并未发现有打包到协议里面。如果要解包，首先要知道这个协议是否压缩过。（个人感觉这里不太好，对于motan自己client调用将配置文件拷贝过去即可，但是对于其他的语言就麻烦了，不太友好）</p>
<h4 id="方法签名"><a href="#方法签名" class="headerlink" title="方法签名"></a>方法签名</h4><p>motan在打包method的时候会对根据方法的interfaceName，methodName，parameterDes拼接起来，md5生成一个方法签名，如果方法签名生成成功，则将方法签名的标志和方法签名打包，否则打包完整的方法信息</p>
<p>如果客户端使用了方法签名，服务端怎么这个方法签名是哪一个方法呢？（首先生成签名的方法是md5的不可逆的，也就是说不可以反解。）</p>
<p>motan的做法是每个服务在export前都会对对应的方法生成签名，并保存签名和方法的映射。</p>
<p>方法签名的好处：最大的好处就是省了流量。也可以带来一点点性能提升。</p>
<hr>
<p>后记：</p>
<p>motan的设计基本没考虑跨语言的调用。有些可惜。</p>
<p>个人并不是很喜欢motan codec的代码，故不会在这里耗太多时间。<br>以后遇到好的codec的代码，再来分享。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-23-motan-rpc.html" title="深入浅出Motan RPC" itemprop="url">深入浅出Motan RPC</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-22T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>深入浅出Motan RPC</p>
<p><strong>目录</strong></p>
<ul>
<li>TOC<br>{:toc}</li>
</ul>
<h3 id="motan"><a href="#motan" class="headerlink" title="motan"></a>motan</h3><h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>本系列文章假设你已经阅读过motan的官方wiki，对motan或者dubbo有一定的了解。对于没有读过wiki的请先阅读<a href="https://github.com/weibocom/motan/wiki/zh_userguide" target="_blank" rel="external">官方wiki</a>。</p>
<hr>
<blockquote>
<p><code>Motan</code>是一套基于java开发的<code>RPC框架</code>，除了常规的点对点调用外，Motan还提供<code>服务治理功能</code>，包括服务节点的自动发现、摘除、高可用和负载均衡等。Motan具有良好的扩展性，主要模块都提供了多种不同的实现，例如支持多种注册中心，支持多种rpc协议等。</p>
</blockquote>
<p><strong>motan定义为一个RPC框架，首先我们看一下RPC的定义：</strong></p>
<blockquote>
<p><code>RPC</code> 的全称是 <code>Remote Procedure Call</code> 是一种进程间通信方式。 它允许程序调用另一个地址空间（通常是共享网络的另一台机器上）的过程或函数，而不用程序员显式编码这个远程调用的细节。<strong>即程序员无论是调用本地的还是远程的函数，本质上编写的调用代码基本相同</strong>。</p>
</blockquote>
<p>RPC本质上要屏蔽远程调用和本地调用的差异性。</p>
<h4 id="motan的架构"><a href="#motan的架构" class="headerlink" title="motan的架构"></a>motan的架构</h4><p><img src="/images/motan/motan-frame.png" alt="Alt text"></p>
<h4 id="motan分层："><a href="#motan分层：" class="headerlink" title="motan分层："></a>motan分层：</h4><p>motan的分层还是比较清晰，可以分为如下六层：</p>
<ul>
<li><p>Registy 服务发现</p>
<blockquote>
<p>服务的注册和发现功能，motan目前实现了两种，zookeeper，consul</p>
</blockquote>
</li>
<li><p>Config 配置层</p>
<blockquote>
<p>主要提供了配置读取，解析，实体生成。同时他也是整个框架的入口。</p>
</blockquote>
</li>
<li><p>Proxy 代理层</p>
<blockquote>
<p>仅客户端有这一层，基于jdk的动态代理。通过InvocationHandler拦截调用，在客户端调用方法前，将调用交给Cluster来处理。</p>
</blockquote>
</li>
<li><p>Cluster </p>
<blockquote>
<p>提供了服务容灾和负载均衡的能力</p>
</blockquote>
</li>
<li><p>Protocol</p>
<blockquote>
<p>通讯层，提供了暴露服务和获取引用的能力。目前仅仅实现了motan协议和injvm协议</p>
</blockquote>
</li>
<li><p>Transport 传输层</p>
<blockquote>
<p>motan的传输层是基于netty封装实现的。</p>
</blockquote>
</li>
</ul>
<h4 id="motan的一些重要概念"><a href="#motan的一些重要概念" class="headerlink" title="motan的一些重要概念"></a>motan的一些重要概念</h4><ul>
<li><p>Provider</p>
<blockquote>
<p>服务提供方，通常可以认为是server端</p>
</blockquote>
</li>
<li><p>Exporter</p>
<blockquote>
<p>服务提供Provider暴露出去就变成Exporter，服务使用方（客户端）可以调用暴露出去的Provider</p>
</blockquote>
</li>
<li><p>Referer</p>
<blockquote>
<p>引用服务，引用的服务会通过配置去调用服务端暴露的服务</p>
</blockquote>
</li>
</ul>
<h4 id="从Caller调用说起"><a href="#从Caller调用说起" class="headerlink" title="从Caller调用说起"></a>从Caller调用说起</h4><p>motan本质上还是一个RPC服务，RPC的本质是实现无差别的调用远程服务。所以，优雅的RPC应该是无论是服务端还是客户端调用都自同一个接口。<br>对于motan，这个接口就是Caller中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Response call(Request request);</div></pre></td></tr></table></figure>
<p><img src="/images/motan/caller.png" alt="Alt text"></p>
<p>实现Caller接口的主要可以分为一下三类：</p>
<ul>
<li><p>Referer</p>
<blockquote>
<p>作为客户端服务的引用，必须有call的能力。</p>
</blockquote>
</li>
<li><p>Provider</p>
<blockquote>
<p>作为服务端暴露服务的provider，故也需事先caller</p>
</blockquote>
</li>
<li><p>Cluster</p>
<blockquote>
<p>客户端在调用前服务后先通过proxy调用Cluster.call（），然后Cluster.call()调用真正的referer.call(),这里Cluster应用了代理模式，在调用前做了一层代理，提供了负载均衡和容错的能力。</p>
</blockquote>
</li>
</ul>
<h4 id="一个request到一个response的过程"><a href="#一个request到一个response的过程" class="headerlink" title="一个request到一个response的过程"></a>一个request到一个response的过程</h4><p><img src="/images/motan/call-motan.png" alt="Alt text"></p>
<p>首先我们通过RefererConfig获取一个客户端调用Service的Proxy，当我们在客户端执行service的方法时，Proxy就会InvokeHandler就会拦截到执行其invoke方法。<br>在执行invoke的时候，我们会调用Cluster.call()方法，而cluster.call()，实际上是一个代理(这个代理主要是用来处理集群功能的，容灾和负载均衡)，真正执行的是Referer.call()<br>referer是一个服务的引用（我们可以理解为他引用了一个调用特定的provider的client），referer.call()会将request消息编码打包，通过netty tcp长连接传输到服务端（在referer.call()调用的时候其实motan用了装饰模式，经过了filter层，对所有的调用做了一层过滤），<br>服务端收到了Request会对其进行解码，并根据协议body里面穿的interfaceName&amp;methodName&amp;parameterDesc（或者是方法签名）找到对应的provider，并执行，获取返回结果Resonse<br>并将response编码传输返回给客户端。</p>
<h4 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h4><p>上面我们已经看到Referer&amp;Provider的重要性，他是服务提供方和服务的引用方。可以说是整个motan RPC最重要的地方之一。那么Referer&amp;Provider分别是在哪里构造的呢？</p>
<p>这个时候我们需要看Protocol了.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Spi</span>(scope = Scope.SINGLETON)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 暴露服务</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> provider</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 引用服务</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> clz</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@param</span> serviceUrl</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;pre&gt;</div><div class="line">	 * 		1） exporter destroy</div><div class="line">	 * 		2） referer destroy</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从protocol的接口我们看到，他提供了暴露服务的方法，提供了获取引用的方法。<br>如果需要详细了解motan的Protocol，请穿越<a href="http://zhizus.com/code/motan-protocol" target="_blank" rel="external">Motan源码解读-Protocol</a></p>
<h4 id="transport"><a href="#transport" class="headerlink" title="transport"></a>transport</h4><h5 id="传输协议header："><a href="#传输协议header：" class="headerlink" title="传输协议header："></a>传输协议header：</h5><table style="border-collapse:collapse;border-spacing:0;border-color:#999"><tr><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4;text-align:center" colspan="7">header</th></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">0-15</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">16-23</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">24-31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">32-95</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">96-127</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">magic</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">version</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">extend flag</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">request id</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">body content length</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">魔数</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">协议版本</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">24-28</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">29-30</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>消息id<br></td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>body包长</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">保留</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">event( 可支持4种event，<br>如normal, exception等)</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">0 is request , 1 is response</td></tr></table>


<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><h4 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h4><p><a href="http://kriszhang.com/motan-rpc-impl/" target="_blank" rel="external">从motan看RPC框架设计</a>（写的不错）</p>
<hr>
<p>后记：</p>
<p>到目前为止，motan的源代码已经读的七七八八了。个人比较喜欢的点如下：</p>
<ul>
<li>1.精简而灵活，到处都留下了扩展的入口。</li>
<li>2.motan代码读起来顺畅，分层清晰，整体设计还是比较优雅。</li>
</ul>
<p>下面重点说一下不喜欢的：</p>
<ul>
<li>1.motan的codec的实现不太喜欢，这块应该还可以实现的更好。</li>
<li>2.不支持跨语言，如果要扩展为自己的协议，代价比较大。</li>
<li>3.netty的版本有点旧</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-22-motan-serialize.html" title="Motan源码解读-serialize" itemprop="url">Motan源码解读-serialize</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-21T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="motan-序列化"><a href="#motan-序列化" class="headerlink" title="motan 序列化"></a>motan 序列化</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><blockquote>
<p><strong>序列化：</strong> 将数据结构或对象转换成二进制串的过程。<br><strong>反序列化：</strong>将在序列化过程中所生成的二进制串转换成数据结构或者对象的过程。</p>
</blockquote>
<p>motan 将RPC<code>请求中的参数、结果等对象进行序列化与反序列化</code>，即进行对象与字节流的互相转换；默认使用对java更友好的hessian2进行序列化。（注意序列化的是请求的参数，和返回的结果，其他的地方不需要序列化）</p>
<p>一个rpc框架的性能主要取决于：线程模型，IO模型，序列化三个方面。（对于有gc机制的jvm来说，零拷贝也很关键）<br>所以一个性能优异的序列化对于rpc是非常重要的。（这里的序列化和反序列化仅仅涉及到请求中的参数、结果等对象，协议其他的信息的序列化见后续的codec章节）</p>
<p>motan会对client端发送的request的请求参数对象进行序列化，也会对服务端下发给response对象进行序列化，如下图所示：</p>
<p><img src="/code/images//motan/motan-register-server-client.jpg" alt=""></p>
<h4 id="motan目前支持两种序列化："><a href="#motan目前支持两种序列化：" class="headerlink" title="motan目前支持两种序列化："></a>motan目前支持两种序列化：</h4><ul>
<li>hession2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol serialization=&quot;hessian2&quot; /&gt;</div></pre></td></tr></table></figure>
<ul>
<li>fastjson</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol serialization=&quot;fastjson&quot; /&gt;</div></pre></td></tr></table></figure>
<h3 id="各种序列化性能对比"><a href="#各种序列化性能对比" class="headerlink" title="各种序列化性能对比"></a>各种序列化性能对比</h3><p><img src="/images/motan/serialize.png" alt=""></p>
<p>我们可以发现fastjson的序列化性能和thrift和protobuf差异已经不太大了，明显好过hession（当然上图比较的不知道hession的版本，可能不准确）<br>dubbo是有针对hession单独做优化的，但是motan默认使用hession，且没做优化。</p>
<h3 id="motan序列化的实现"><a href="#motan序列化的实现" class="headerlink" title="motan序列化的实现"></a>motan序列化的实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个可以可以扩展的，也就是你可以扩展motan用你想要的序列化方式</span></div><div class="line"><span class="meta">@Spi</span>(scope=Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line">	<span class="comment">// 将对象序列话称字节数组</span></div><div class="line">	<span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException;</div><div class="line">	<span class="comment">// 将字节数组反序列化成对象</span></div><div class="line">	&lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; clz)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体的实现要看hession2和fastjson了。</p>
<p>motan序列化&amp;反序列化仅仅包含了请求参数和返回对象，其他对象的编解码，我们且看下一篇文章。</p>
<hr>
<p>后记：</p>
<p>1.fastjson确实够快，使用也挺方便的。</p>
<p>2.如果我们需要扩展motan实现thrift或者protobuf还需要hession或者fastjson来辅助序列化吗？</p>
<p>首先hession可以排除，使用hession跨语言调用就比较难实现了。<br>那么需要辅助的fastjson来序列化吗？没必要。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-21-motan-hastratege.html" title="Motan源码解读-容错策略" itemprop="url">Motan源码解读-容错策略</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-20T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="Motan的容错策略"><a href="#Motan的容错策略" class="headerlink" title="Motan的容错策略"></a>Motan的容错策略</h3><blockquote>
<p>Motan 在集群调用失败时，提供了两种容错方案，并支持自定义扩展。 高可用集群容错策略在Client端生效，因此需在Client端添加配置 目前支持的集群容错策略有：</p>
</blockquote>
<ul>
<li><strong>Failover 失效切换（缺省）</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... haStrategy=&quot;failover&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>失败自动切换，当出现失败，重试其它服务器。</p>
</blockquote>
<ul>
<li><strong>Failfast 快速失败</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... haStrategy=&quot;failfast&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>快速失败，只发起一次调用，失败立即报错。</p>
</blockquote>
<h3 id="dubbo的容错策略"><a href="#dubbo的容错策略" class="headerlink" title="dubbo的容错策略"></a>dubbo的容错策略</h3><p>motan实际上是dubbo的子集，也可以说是阉割版。一下是dubbo支持的容错策略。</p>
<ul>
<li><p><strong>1.failover cluster</strong></p>
<blockquote>
<p>失败自动切换，当出现失败，重试其他服务器（缺省），通常用于读操作，但重试会带来更长的延时，可通过retries=“2”来设置重试次数（不含第一次）</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service retries=&quot;2&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong>2.failfast cluster</strong></li>
</ul>
<blockquote>
<p>快速失效，只发起一次调用，失败立即报错。通常用于非幂等性写操作，比如说新增记录</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;failfast&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p><strong>3.failsaft cluster</strong></p>
<blockquote>
<p>失败安全，出现异常时，直接忽略，通常用于写入审计日志等操作</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;failsafe&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong>4.failback cluster</strong></li>
</ul>
<blockquote>
<p>失败自动恢复，后台记录失败请求，定时重发，通常用于消息通知操作</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;failback&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p><strong>5.forking cluster</strong></p>
<blockquote>
<p>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多的服务器资源。可通过forks=“2”来设置最大并行数。</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;forking&quot;&gt;</div></pre></td></tr></table></figure>
<h3 id="motan容错策略源代码解读"><a href="#motan容错策略源代码解读" class="headerlink" title="motan容错策略源代码解读"></a>motan容错策略源代码解读</h3><p>motan的容错策略尽管支持的不够多，但是对于大部分场景已经够用。而对于一些特殊场景我们可以基于motan 的SPI机制扩展实现自己需要的容错策略。</p>
<p><img src="http://zhizus.com/code/images//motan/14612385789967.jpg" alt="enter image description here"></p>
<p>motan的容错策略及时基于java的<code>策略模式</code>实现的。</p>
<blockquote>
<p>策略模式作为一种软件设计模式，指对象有某个行为，但是在不同的场景中，该行为有不同的实现算法。比如每个人都要“交个人所得税”，但是“在美国交个人所得税”和“在中国交个人所得税”就有不同的算税方法。</p>
</blockquote>
<p>motan容错的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以通过motan的SPI机制扩展</span></div><div class="line"><span class="meta">@Spi</span>(scope = Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HaStrategy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// 从后面的实现来看，没发现有什么用</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(URL url)</span></span>;</div><div class="line">    <span class="comment">//基于具体的LoadBalance调用请求，问答模式，一个request返回一个response，</span></div><div class="line">    <span class="function">Response <span class="title">call</span><span class="params">(Request request, LoadBalance&lt;T&gt; loadBalance)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractHaStrategy这个抽象方法做的事情貌似没什么用，直接看具体的实现：<br>failfast很简单，直接略去。看failover的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpiMeta</span>(name = <span class="string">"failover"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverHaStrategy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractHaStrategy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//确保每个线程持有一份单独的ArrayList&lt;Referer&lt;T&gt;（FailoverHaStrategy，会有单个实例被多个线程调用）</span></div><div class="line">    <span class="keyword">protected</span> ThreadLocal&lt;List&lt;Referer&lt;T&gt;&gt;&gt; referersHolder = <span class="keyword">new</span> ThreadLocal&lt;List&lt;Referer&lt;T&gt;&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">protected</span> java.util.List&lt;com.weibo.api.motan.rpc.Referer&lt;T&gt;&gt; initialValue() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Referer&lt;T&gt;&gt;();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request, LoadBalance&lt;T&gt; loadBalance)</span> </span>&#123;</div><div class="line"></div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = selectReferers(request, loadBalance);</div><div class="line">        <span class="keyword">if</span> (referers.isEmpty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(String.format(<span class="string">"FailoverHaStrategy No referers for request:%s, loadbalance:%s"</span>, request,</div><div class="line">                    loadBalance));</div><div class="line">        &#125;</div><div class="line">        URL refUrl = referers.get(<span class="number">0</span>).getUrl();</div><div class="line">        <span class="comment">// 先使用method的配置</span></div><div class="line">        <span class="keyword">int</span> tryCount =</div><div class="line">                refUrl.getMethodParameter(request.getMethodName(), request.getParamtersDesc(), URLParamType.retries.getName(),</div><div class="line">                        URLParamType.retries.getIntValue());</div><div class="line">        <span class="comment">// 如果有问题，则设置为不重试</span></div><div class="line">        <span class="keyword">if</span> (tryCount &lt; <span class="number">0</span>) &#123;</div><div class="line">            tryCount = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tryCount; i++) &#123;</div><div class="line">            Referer&lt;T&gt; refer = referers.get(i % referers.size());</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                request.setRetries(i);</div><div class="line">                <span class="keyword">return</span> refer.call(request);</div><div class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">                <span class="comment">// 对于业务异常，直接抛出</span></div><div class="line">                <span class="keyword">if</span> (ExceptionUtil.isBizException(e)) &#123;</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i &gt;= tryCount) &#123;</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">                LoggerUtil.warn(String.format(<span class="string">"FailoverHaStrategy Call false for request:%s error=%s"</span>, request, e.getMessage()));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">      <span class="comment">// 从逻辑来看 代码不会到这个地方（如果是业务逻辑直接抛出，如果达到重试次数，也直接抛出异常了二中断了）</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="string">"FailoverHaStrategy.call should not come here!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 先从threadLocal拿到当前线程持有的List&lt;Referer&lt;T&gt;&gt; referers，然后清除，再从loadbalance哪里复制一份最新的引用添加进去</div><div class="line">     * haStratege能感知到引用列表的实时变化</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@param</span> loadBalance</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> List&lt;Referer&lt;T&gt;&gt; selectReferers(Request request, LoadBalance&lt;T&gt; loadBalance) &#123;</div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = referersHolder.get();</div><div class="line">        referers.clear();</div><div class="line">        loadBalance.selectToHolder(request, referers);</div><div class="line">        <span class="keyword">return</span> referers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码花费了些时间理解。</p>
<ul>
<li>1.为什么要将引用放到new ThreadLocal<list<referer<t>&gt;&gt;()?</list<referer<t></li>
</ul>
<blockquote>
<p>首先单个HAStratege会被多个线程调用，加入ThreadLocal必然是为了保证每个线程持有单独的一份refererList。<br>如果没有ThreadLocal，当其他线程调用selectReferers()会改变refererList，这个时候call方法中的循环会有问题，临界条件可能会抛异常。</p>
</blockquote>
<ul>
<li>2.为什么需要selectReferers？</li>
</ul>
<blockquote>
<p>这个方法可以确保referer列表的实时性，能够实时感知到referer列表的变化。</p>
</blockquote>
<h3 id="关于容错的其他考虑"><a href="#关于容错的其他考虑" class="headerlink" title="关于容错的其他考虑"></a>关于容错的其他考虑</h3><p>上文讨论的容错都是基于业务调用方考虑的一些策略。无论是motan还是dubbo都没有基于服务端自身保护的考虑。</p>
<blockquote>
<p>当企业微服务化以后，服务之间会有错综复杂的依赖关系，例如，一个前端请求一般会依赖于多个后端服务。在实际生产环境中，服务往往不是百分百可靠，服务可能会出错或者产生延迟，如果一个应用不能对其依赖的故障进行容错和隔离，那么该应用本身就处在被拖垮的风险中。在一个高流量的网站中，某个单一后端一旦发生延迟，可能在数秒内导致所有应用资源(线程，队列等)被耗尽，造成所谓的雪崩效应(Cascading Failure)，严重时可致整个网站瘫痪。</p>
</blockquote>
<ul>
<li><p><strong>电路熔断器模式(Circuit Breaker Patten),</strong> 该模式的原理类似于家里的电路熔断器，如果家里的电路发生短路，熔断器能够主动熔断电路，以避免灾难性损失。在分布式系统中应用电路熔断器模式后，当目标服务慢或者大量超时，调用方能够主动熔断，以防止服务被进一步拖垮；如果情况又好转了，电路又能自动恢复，这就是所谓的弹性容错，系统有自恢复能力。下图Fig 8是一个典型的具备弹性恢复能力的电路保护器状态图，正常状态下，电路处于关闭状态(Closed)，如果调用持续出错或者超时，电路被打开进入熔断状态(Open)，后续一段时间内的所有调用都会被拒绝(Fail Fast)，一段时间以后，保护器会尝试进入半熔断状态(Half-Open)，允许少量请求进来尝试，如果调用仍然失败，则回到熔断状态，如果调用成功，则回到电路闭合状态。</p>
</li>
<li><p><strong>舱壁隔离模式(Bulkhead Isolation Pattern)</strong>，顾名思义，该模式像舱壁一样对资源或失败单元进行隔离，如果一个船舱破了进水，只损失一个船舱，其它船舱可以不受影响 。线程隔离(Thread Isolation)就是舱壁隔离模式的一个例子，假定一个应用程序A调用了Svc1/Svc2/Svc3三个服务，且部署A的容器一共有120个工作线程，采用线程隔离机制，可以给对Svc1/Svc2/Svc3的调用各分配40个线程，当Svc2慢了，给Svc2分配的40个线程因慢而阻塞并最终耗尽，线程隔离可以保证给Svc1/Svc3分配的80个线程可以不受影响，如果没有这种隔离机制，当Svc2慢的时候，120个工作线程会很快全部被对Svc2的调用吃光，整个应用程序会全部慢下来。</p>
</li>
<li><p><strong>限流(Rate Limiting/Load Shedder)</strong>，服务总有容量限制，没有限流机制的服务很容易在突发流量(秒杀，双十一)时被冲垮。限流通常指对服务限定并发访问量，比如单位时间只允许100个并发调用，对超过这个限制的请求要拒绝并回退。</p>
</li>
<li><p><strong>回退(fallback)</strong>，在熔断或者限流发生的时候，应用程序的后续处理逻辑是什么？回退是系统的弹性恢复能力，常见的处理策略有，直接抛出异常，也称快速失败(Fail Fast)，也可以返回空值或缺省值，还可以返回备份数据，如果主服务熔断了，可以从备份服务获取数据。</p>
</li>
</ul>
<blockquote>
<p>Netflix将上述容错模式和最佳实践集成到一个称为<code>Hystrix</code>的开源组件中，凡是需要容错的依赖点(服务，缓存，数据库访问等)，开发人员只需要将调用封装在Hystrix Command里头，则相关调用就自动置于Hystrix的弹性容错保护之下。Hystrix组件已经在Netflix经过多年运维验证，是Netflix微服务平台稳定性和弹性的基石，正逐渐被社区接受为标准容错组件。</p>
</blockquote>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>容灾策略motan实现的比较简单 ，代码也相对好懂，可以参考借鉴。</p>
<hr>
<p>后记：<br>希望有时间可以看Hystrix的实现，</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-21-motan-protocol.html" title="Motan源码解读-Protocol" itemprop="url">Motan源码解读-Protocol</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-20T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>protocol可以说是motan最重要的部分之一。<br>暴露一个服务引用一个服务都是在这块实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Spi</span>(scope = Scope.SINGLETON)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 暴露服务</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> provider</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 引用服务</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> clz</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@param</span> serviceUrl</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;pre&gt;</div><div class="line">	 * 		1） exporter destroy</div><div class="line">	 * 		2） referer destroy</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">     * </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Provider</li>
</ul>
<blockquote>
<p>服务提供方，通常可以认为是server端</p>
</blockquote>
<ul>
<li>Exporter</li>
</ul>
<blockquote>
<p>服务提供Provider暴露出去就变成Exporter，服务使用方（客户端）可以调用暴露出去的Provider</p>
</blockquote>
<ul>
<li>Referer</li>
</ul>
<blockquote>
<p>引用服务，引用的服务会通过配置去调用服务端暴露的服务</p>
</blockquote>
<p>现在我们应该会有一定的认识，对于protocol。不管是暴露服务还是引用服务都是通过protocol来实现的。可以说他是学习motan的一个入口。</p>
<p>我们看到这个接口上面也有@SPI注解，就是说protocol可以基于spi机制扩展，<code>也就说你可以对motan进行为所欲为的扩展</code>。</p>
<h3 id="protocol的实现"><a href="#protocol的实现" class="headerlink" title="protocol的实现"></a>protocol的实现</h3><p><img src="/images/motan/Protocol.png" alt=""></p>
<p>这里面再次用到了<code>模板方法设计模式</code>。</p>
<p>下面看我们看AbstractProtocol抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProtocol</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    <span class="comment">// 存放本地export的服务，用于injvm的时候查找本地服务</span></div><div class="line">    <span class="keyword">protected</span> ConcurrentHashMap&lt;String, Exporter&lt;?&gt;&gt; exporterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Exporter&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Map&lt;String, Exporter&lt;?&gt;&gt; getExporterMap() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(exporterMap);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Error: url is null"</span>,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Error: provider is null, url="</span> + url,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String protocolKey = MotanFrameworkUtil.getProtocolKey(url);</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (exporterMap) &#123;</div><div class="line">            Exporter&lt;T&gt; exporter = (Exporter&lt;T&gt;) exporterMap.get(protocolKey);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (exporter != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Error: service already exist, url="</span> + url,</div><div class="line">                        MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            exporter = createExporter(provider, url);</div><div class="line">            exporter.init();</div><div class="line"></div><div class="line">            exporterMap.put(protocolKey, exporter);</div><div class="line"></div><div class="line">            LoggerUtil.info(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Success: url="</span> + url);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> exporter;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> refer(clz, url, url);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" refer Error: url is null"</span>,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (clz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" refer Error: class is null, url="</span> + url,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Referer&lt;T&gt; referer = createReferer(clz, url, serviceUrl);</div><div class="line">        referer.init();</div><div class="line"></div><div class="line">        LoggerUtil.info(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" refer Success: url="</span> + url);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> referer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 用于子类扩展，通过扩展这个方法，可以使服务端暴露出自定义的服务。</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">createExporter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// 用于子类扩展，通过扩展这个方法，可以使客户端有自定义的服务引用。</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">createReferer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String key : exporterMap.keySet()) &#123;</div><div class="line">            Node node = exporterMap.remove(key);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    node.destroy();</div><div class="line"></div><div class="line">                    LoggerUtil.info(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" destroy node Success: "</span> + node);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    LoggerUtil.error(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" destroy Error"</span>, t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们需要实现自己的Export或者Referer，我们继承AbstractProtocol这个方法覆盖里面的两个抽象方法就好了。</p>
<p>比如说，我们希望motan支持protobuf或者thrift，那么我们继承AbstractProtocol这个抽象类，分别实现createExporter，createReferer方法。</p>
<p>那么这两个方法怎么实现呢？</p>
<p>我们来看motan给出的一个默认实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpiMeta</span>(name = <span class="string">"motan"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcProtocol</span> <span class="keyword">extends</span> <span class="title">AbstractProtocol</span> </span>&#123;</div><div class="line">    <span class="comment">// 多个service可能在相同端口进行服务暴露，因此来自同个端口的请求需要进行路由以找到相应的服务，同时不在该端口暴露的服务不应该被找到</span></div><div class="line">    <span class="comment">// ProviderMessageRouter负责了服务端消息的路由调用，同时也负责了心跳的逻辑</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, ProviderMessageRouter&gt; ipPort2RequestRouter = <span class="keyword">new</span> HashMap&lt;String, ProviderMessageRouter&gt;();</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">createExporter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultRpcExporter&lt;T&gt;(provider, url);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">createReferer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultRpcReferer&lt;T&gt;(clz, url, serviceUrl);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * rpc provider</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@author</span> maijunsheng</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcExporter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractExporter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> Server server;</div><div class="line">        <span class="keyword">private</span> EndpointFactory endpointFactory;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DefaultRpcExporter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(provider, url);</div><div class="line">            ProviderMessageRouter requestRouter = initRequestRouter(url);</div><div class="line">            endpointFactory =</div><div class="line">                    ExtensionLoader.getExtensionLoader(EndpointFactory.class).getExtension(</div><div class="line">                            url.getParameter(URLParamType.endpointFactory.getName(), URLParamType.endpointFactory.getValue()));</div><div class="line">            <span class="comment">//创建server，目前motan仅实现了NettyServer（ExtensionLoader出现代表是可以扩展的，可以扩展自己的server）</span></div><div class="line">            server = endpointFactory.createServer(url, requestRouter);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>&#123;</div><div class="line">            String protocolKey = MotanFrameworkUtil.getProtocolKey(url);</div><div class="line">            String ipPort = url.getServerPortStr();</div><div class="line">            Exporter&lt;T&gt; exporter = (Exporter&lt;T&gt;) exporterMap.remove(protocolKey);</div><div class="line">            <span class="keyword">if</span> (exporter != <span class="keyword">null</span>) &#123;</div><div class="line">                exporter.destroy();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">synchronized</span> (ipPort2RequestRouter) &#123;</div><div class="line">                ProviderMessageRouter requestRouter = ipPort2RequestRouter.get(ipPort);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (requestRouter != <span class="keyword">null</span>) &#123;</div><div class="line">                    requestRouter.removeProvider(provider);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            LoggerUtil.info(<span class="string">"DefaultRpcExporter unexport Success: url=&#123;&#125;"</span>, url);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="comment">//打开服务，</span></div><div class="line">            <span class="keyword">boolean</span> result = server.open();</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> server.isAvailable();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">            endpointFactory.safeReleaseResource(server, url);</div><div class="line">            LoggerUtil.info(<span class="string">"DefaultRpcExporter destory Success: url=&#123;&#125;"</span>, url);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">private</span> ProviderMessageRouter <span class="title">initRequestRouter</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">            ProviderMessageRouter requestRouter = <span class="keyword">null</span>;</div><div class="line">            String ipPort = url.getServerPortStr();</div><div class="line">            <span class="keyword">synchronized</span> (ipPort2RequestRouter) &#123;</div><div class="line">                requestRouter = ipPort2RequestRouter.get(ipPort);</div><div class="line">                <span class="keyword">if</span> (requestRouter == <span class="keyword">null</span>) &#123;</div><div class="line">                    requestRouter = <span class="keyword">new</span> ProviderProtectedMessageRouter(provider);</div><div class="line">                    ipPort2RequestRouter.put(ipPort, requestRouter);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    requestRouter.addProvider(provider);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> requestRouter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * rpc referer</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@author</span> maijunsheng</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcReferer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractReferer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> Client client;</div><div class="line">        <span class="keyword">private</span> EndpointFactory endpointFactory;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DefaultRpcReferer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(clz, url, serviceUrl);</div><div class="line"></div><div class="line">            endpointFactory =</div><div class="line">                    ExtensionLoader.getExtensionLoader(EndpointFactory.class).getExtension(</div><div class="line">                            url.getParameter(URLParamType.endpointFactory.getName(), URLParamType.endpointFactory.getValue()));</div><div class="line">            <span class="comment">// 创建client</span></div><div class="line">            client = endpointFactory.createClient(url);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 用这个协议的服务，每次调用必经过这个方法</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Response <span class="title">doCall</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 为了能够实现跨group请求，需要使用server端的group。</span></div><div class="line">                request.setAttachment(URLParamType.group.getName(), serviceUrl.getGroup());</div><div class="line">                <span class="keyword">return</span> client.request(request);</div><div class="line">            &#125; <span class="keyword">catch</span> (TransportException exception) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="string">"DefaultRpcReferer call Error: url="</span> + url.getUri(), exception);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decrActiveCount</span><span class="params">(Request request, Response response)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (response == <span class="keyword">null</span> || !(response <span class="keyword">instanceof</span> Future)) &#123;</div><div class="line">                activeRefererCount.decrementAndGet();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            Future future = (Future) response;</div><div class="line">            future.addListener(<span class="keyword">new</span> FutureListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    activeRefererCount.decrementAndGet();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// 打开client</span></div><div class="line">            <span class="keyword">boolean</span> result = client.open();</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> client.isAvailable();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">            endpointFactory.safeReleaseResource(client, url);</div><div class="line">            LoggerUtil.info(<span class="string">"DefaultRpcReferer destory client: url=&#123;&#125;"</span> + url);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ProviderMessageRouter：这个类也比较核心，call方法处理了Server消息路由调用的逻辑，handle方法理了心跳的逻辑</p>
<hr>
<p>后记：看到这里，觉得motan真心不错，虽然功能算不上丰富，但是处处留了扩展的入口。所以还在纠结要不要用motan的可以不用纠结了，即便你需要的功能motan没有覆盖到，<br>但是你多半也可以扩展去改造它。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-21-motan-override.html" title="Motan源码解读-源码结构" itemprop="url">Motan源码解读-源码结构</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-20T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>旨在对motan包结构熟悉，顺带会根据包结构列出系列文章的索引。</p>
<h3 id="motan包结构"><a href="#motan包结构" class="headerlink" title="motan包结构"></a>motan包结构</h3><pre><code>motan-benchmark // 压测相关
motan-core    //motan核心代码，也是源码解析的主要包
motan-demo    // 示例，快速上手的最佳方法
motan-extension // 扩展
motan-manager // 管理后台
motan-registry-consul    //基于consul的服务发现实现
motan-registry-zookeeper // 基于zookeeper的服务发现实现
motan-springsupport // spring容器的支持，也支持springboot
motan-transport-netty // netty传输的封装
</code></pre><h4 id="motan-core"><a href="#motan-core" class="headerlink" title="motan-core"></a>motan-core</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">└─com</div><div class="line">    └─weibo</div><div class="line">        └─api</div><div class="line">            └─motan</div><div class="line">                ├─cluster</div><div class="line">                │  ├─ha //①容灾策略</div><div class="line">                │  ├─loadbalanc //②负载均衡</div><div class="line">                │  └─support</div><div class="line">                ├─codec //③编解码</div><div class="line">                ├─common</div><div class="line">                ├─config //④配置</div><div class="line">                │  ├─annotation</div><div class="line">                │  └─handler</div><div class="line">                ├─core</div><div class="line">                │  └─extension //⑤ SPI机制扩展</div><div class="line">                ├─exception // ⑥异常</div><div class="line">                ├─filter //⑦过滤器</div><div class="line">                ├─log //⑧日志</div><div class="line">                ├─protocol //⑨责点到点的通讯(有别于我们理解的protocol)</div><div class="line">                │  ├─injvm</div><div class="line">                │  ├─rpc</div><div class="line">                │  └─support</div><div class="line">                ├─proxy //⑩代理</div><div class="line">                │  └─spi</div><div class="line">                ├─registry //⑪服务注册</div><div class="line">                │  └─support</div><div class="line">                │      └─comman</div><div class="line">                ├─rpc</div><div class="line">                ├─serialize //⑫序列化</div><div class="line">                ├─switcher</div><div class="line">                ├─transport</div><div class="line">                │  └─support</div><div class="line">                └─util</div></pre></td></tr></table></figure>
<p>这个包是motan的核心实现，里面的大部分代码，接下的文章都会涉及到。</p>
<p>①<a href="http://zhizus.com/code/motan-hastratege" target="_blank" rel="external">motan-容灾策略</a></p>
<p>②<a href="http://zhizus.com/code/motan-loadbalance" target="_blank" rel="external">motan-负载均衡</a></p>
<p>⑤<a href="http://zhizus.com/code/motan-spi" target="_blank" rel="external">motan-SPI机制扩展</a></p>
<p>⑦<a href="http://zhizus.com/code/motan-filter" target="_blank" rel="external">motan-过滤器</a></p>
<p>⑨<a href="http://zhizus.com/code/motan-protocol" target="_blank" rel="external">motan-protocol</a></p>
<h4 id="motan-transport-netty"><a href="#motan-transport-netty" class="headerlink" title="motan-transport-netty"></a>motan-transport-netty</h4><p>⑨<a href="http://zhizus.com/code/motan-clientMessage" target="_blank" rel="external">motan-netty-client异步消息</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-21-motan-filter.html" title="Motan源码解读-Filter" itemprop="url">Motan源码解读-Filter</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-20T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>很多服务都有filter这个概念，filter就像在管道前的过滤器，只要通过管道的请求必须先经过过滤器。<br>过滤器可以做很多事情，类似权限控制，限流，统计，上报，监控等等。有些为服务架构会把filter单独抽出来作为getway服务。</p>
<h3 id="motan-filter："><a href="#motan-filter：" class="headerlink" title="motan filter："></a>motan filter：</h3><h4 id="目前实现的filter"><a href="#目前实现的filter" class="headerlink" title="目前实现的filter"></a>目前实现的filter</h4><ul>
<li>AccessLogFilter</li>
</ul>
<blockquote>
<p>统计整个call的执行状况，尽量到最上层，最后执行.<br>此filter会对性能产生一定影响，请求量较大时建议关闭。</p>
</blockquote>
<ul>
<li>AccessStatisticFilter</li>
</ul>
<p>&gt;</p>
<ul>
<li>ActiveLimitFilter</li>
</ul>
<blockquote>
<p>limit active count，判断某个接口并发数是否超限，如果超过限制，则上抛异常,同时做简单的统计。 此filter比较严格，尽量放到底层较早执行。</p>
</blockquote>
<ul>
<li>ServiceMockFilter</li>
</ul>
<blockquote>
<p>mock serivce。测试场景使用</p>
</blockquote>
<ul>
<li>SwitcherFilter</li>
</ul>
<blockquote>
<p>服务降级的filter，</p>
</blockquote>
<h4 id="按使用的地方划分"><a href="#按使用的地方划分" class="headerlink" title="按使用的地方划分"></a>按使用的地方划分</h4><ul>
<li><strong>服务端的filter</strong></li>
<li><strong>客户端的filter</strong></li>
</ul>
<p>motan的服务端和客户端都可以添加filter，可以是相同的filter也可以是不同的filter</p>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>下面我们来看filter的ProtocolFilterDecorator 代码(代码仅保留了分析相关部分)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolFilterDecorator</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">decorateWithFilter</span><span class="params">(Referer&lt;T&gt; referer, URL url)</span> </span>&#123;</div><div class="line">        List&lt;Filter&gt; filters = getFilters(url, MotanConstants.NODE_TYPE_REFERER);</div><div class="line">        Referer&lt;T&gt; lastRef = referer;</div><div class="line">        <span class="keyword">for</span> (Filter filter : filters) &#123;</div><div class="line">            <span class="keyword">final</span> Filter f = filter;</div><div class="line">            <span class="keyword">final</span> Referer&lt;T&gt; lf = lastRef;</div><div class="line">            lastRef = <span class="keyword">new</span> Referer&lt;T&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">	                <span class="comment">// 这里可以通过配置来控制，对于重试的请求要不要经过filter，比如有些安全校验的，第一次已经校验通过，重试自然不用在校验一次，但是对于有些统计来说，可能会认为不管是不是重试，都需要统计，这里通过配置把这种情况暴露给使用者，把决定权留给使用方</span></div><div class="line">                    <span class="keyword">if</span> (!f.getClass().getAnnotation(Activation.class).retry() &amp;&amp; request.getRetries() != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> lf.call(request);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> f.filter(lf, request);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">               ...</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> lastRef;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">Provider&lt;T&gt; <span class="title">decorateWithFilter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">        List&lt;Filter&gt; filters = getFilters(url, MotanConstants.NODE_TYPE_SERVICE);</div><div class="line">        <span class="keyword">if</span> (filters == <span class="keyword">null</span> || filters.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> provider;</div><div class="line">        &#125;</div><div class="line">        Provider&lt;T&gt; lastProvider = provider;</div><div class="line">        <span class="keyword">for</span> (Filter filter : filters) &#123;</div><div class="line">            <span class="keyword">final</span> Filter f = filter;</div><div class="line">            <span class="keyword">final</span> Provider&lt;T&gt; lp = lastProvider;</div><div class="line">            lastProvider = <span class="keyword">new</span> Provider&lt;T&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> f.filter(lp, request);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ...</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> lastProvider;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这个类的名字我们可以可以猜测motan的filter是基于java的<code>装饰模式</code>了，关于java的装饰者模式，（最经典的是jdk的IO部分的用法）</p>
<blockquote>
<p><strong>装饰模式：</strong>在不必改变原类文件和使用继承的情况下，动态地扩展一个对象的功能。它是通过创建一个包装对象，也就是装饰来包裹真实的对象。</p>
</blockquote>
<p>这个类中包装了两个filter，一个是把客户端的referer decorateWithFilter，另一个是把服务端的Provider decorateWithFilter。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>对于filter，作用大多是过滤，一般越早越好，如果不满足过滤条件，能够早些丢弃，不会浪费资源对那些不满足filter过滤条件的请求做其他的处理。</p>
<p>所以一般encode&amp;decode完成的请求会立即进到filter过滤。</p>
<hr>
<p>后记：后面会补充</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016-09-20-motan-loadbalance.html" title="Motan源码解读-负载均衡" itemprop="url">Motan源码解读-负载均衡</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="DempeZheng" target="_blank" itemprop="author">DempeZheng</a>
		
  <p class="article-time">
    <time datetime="2016-09-19T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-09-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="负载均衡的策略"><a href="#负载均衡的策略" class="headerlink" title="负载均衡的策略"></a>负载均衡的策略</h4><blockquote>
<p>Motan 在集群负载均衡时，提供了多种方案，缺省为 ActiveWeight，并支持自定义扩展。 负载均衡策略在Client端生效，因此需在Client端添加配置</p>
</blockquote>
<p><strong>目前支持的负载均衡策略有：</strong></p>
<ul>
<li>ActiveWeight(缺省)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;activeWeight&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>低并发度优先： referer 的某时刻的 call 数越小优先级越高<br>由于 Referer List 可能很多，比如上百台，如果每次都要从这上百个 Referer 或者最低并发的几个，性能有些损耗，因此 random.nextInt(list.size()) 获取一个起始的 index，然后获取最多不超过 MAX_REFERER_COUNT 的状态是 isAvailable 的 referer 进行判断 activeCount.</p>
</blockquote>
<ul>
<li>Random</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;random&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>随机，按权重设置随机概率。<br>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</p>
</blockquote>
<ul>
<li>RoundRobin</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;roundrobin&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>轮循，按公约后的权重设置轮循比率</p>
</blockquote>
<ul>
<li>LocalFirst</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;localFirst&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>本地服务优先获取策略，对referers根据ip顺序查找本地服务，多存在多个本地服务，获取Active最小的本地服务进行服务。<br>当不存在本地服务，但是存在远程RPC服务，则根据ActivWeight获取远程RPC服务<br>当两者都存在，所有本地服务都应优先于远程服务，本地RPC服务与远程RPC服务内部则根据ActiveWeight进行</p>
</blockquote>
<ul>
<li>Consistent</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;consistent&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>一致性 Hash，相同参数的请求总是发到同一提供者</p>
</blockquote>
<ul>
<li>ConfigurableWeight</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;configurableWeight&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>权重可配置的负载均衡策略</p>
</blockquote>
<h4 id="motan加载loadbalance策略的机制"><a href="#motan加载loadbalance策略的机制" class="headerlink" title="motan加载loadbalance策略的机制"></a>motan加载loadbalance策略的机制</h4><p>上面我们了解了motan支持的负载均衡的策略，下面我们来剖析一下motan怎么实现的。</p>
<p>RPCClient首先会经过一层HA（这里 motan实现了两种容灾策略，failfast&amp;failover），然后会根据配置的loadbalance的策略选取相应的nettyClient发送请求到RPCServer。流程如下图所示：</p>
<p><img src="/images/motan/14612385789967.jpg" alt=""></p>
<p>motan的loadbalance策略实现在客户端，客户端初始化时会根据配置，基于spi机制查找对应的实现（不了解SPI的可以看<a href="http://zhizus.com/code/motan-spi" target="_blank" rel="external">Motan源码解读-SPI机制</a>加载loadbalance的实现。<br>调用链如下图所示：</p>
<p><img src="/images/motan/motan-lb.png" alt=""></p>
<h4 id="motan-LoadBalance实现"><a href="#motan-LoadBalance实现" class="headerlink" title="motan LoadBalance实现"></a>motan LoadBalance实现</h4><p><img src="/images/motan/loadbalance.png" alt=""></p>
<p>接下来，我们看loadbalance接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以基于SPI扩展，使用方可以实现自己的LoadBalance</span></div><div class="line"><span class="meta">@Spi</span>(scope = Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoadBalance</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//当可用的应用列表变化时会调用这个方法刷新（motan的可用引用列表是基于服务发现这种模式实现，目前实现了consul&amp;zk）</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(List&lt;Referer&lt;T&gt;&gt; referers)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 基于负载均衡的策略选择可用的引用</span></div><div class="line">    <span class="function">Referer&lt;T&gt; <span class="title">select</span><span class="params">(Request request)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// FailoverHaStrategy会使用到这个，多线程场景</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">selectToHolder</span><span class="params">(Request request, List&lt;Referer&lt;T&gt;&gt; refersHolder)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// ?? 仅仅属于WeightLoadBalance的特性，定义在最上层接口是否合适？？</span></div><div class="line">    <span class="comment">//cluster.getLoadBalance().setWeightString(weights); 这里使用的时候判断一下类型，对WeightLoadBalance这种类型单独处理向下转型是否可以？</span></div><div class="line">    <span class="comment">// 或者是否有其他更好的办法？？</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setWeightString</span><span class="params">(String weightString)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们AbstractLoadBalance,实现了公有的基础逻辑。将不同的策略交由子类去实现，实际上应用到了java设计模式的模板模式。</p>
<blockquote>
<p>模板模式在模板模式（Template Pattern）中，一个抽象类公开定义了执行它的方法的方式/模板。它的子类可以按需要重写方法实现，但调用将以抽象类中定义的方式进行。这种类型的设计模式属于行为型模式。</p>
</blockquote>
<p>下面我们看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLoadBalance</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">LoadBalance</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Referer&lt;T&gt;&gt; referers;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(List&lt;Referer&lt;T&gt;&gt; referers)</span> </span>&#123;</div><div class="line">        <span class="comment">// 只能引用替换，不能进行referers update。</span></div><div class="line">        <span class="keyword">this</span>.referers = referers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Referer&lt;T&gt; <span class="title">select</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = <span class="keyword">this</span>.referers;</div><div class="line"></div><div class="line">        Referer&lt;T&gt; ref = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (referers.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">            ref = doSelect(request);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (referers.size() == <span class="number">1</span>) &#123;</div><div class="line">            ref = referers.get(<span class="number">0</span>).isAvailable() ? referers.get(<span class="number">0</span>) : <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> ref;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" No available referers for call request:"</span> + request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectToHolder</span><span class="params">(Request request, List&lt;Referer&lt;T&gt;&gt; refersHolder)</span> </span>&#123;</div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = <span class="keyword">this</span>.referers;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (referers == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" No available referers for call : referers_size= 0 "</span></div><div class="line">                    + MotanFrameworkUtil.toString(request));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (referers.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">            doSelectToHolder(request, refersHolder);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (referers.size() == <span class="number">1</span> &amp;&amp; referers.get(<span class="number">0</span>).isAvailable()) &#123;</div><div class="line">            refersHolder.add(referers.get(<span class="number">0</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (refersHolder.isEmpty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" No available referers for call : referers_size="</span></div><div class="line">                    + referers.size() + <span class="string">" "</span> + MotanFrameworkUtil.toString(request));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> List&lt;Referer&lt;T&gt;&gt; getReferers() &#123;</div><div class="line">        <span class="keyword">return</span> referers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWeightString</span><span class="params">(String weightString)</span> </span>&#123;</div><div class="line">        LoggerUtil.info(<span class="string">"ignore weightString:"</span> + weightString);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Referer&lt;T&gt; <span class="title">doSelect</span><span class="params">(Request request)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doSelectToHolder</span><span class="params">(Request request, List&lt;Referer&lt;T&gt;&gt; refersHolder)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>子类重写<code>doSelect(Request request)</code>方法就是实现自己的策略。(里面还有一个doSelectToHolder(Request request, List<referer<t>&gt; refersHolder)方法，这个FailoverHaStrategy会涉及到，我们下一篇在讨论)</referer<t></p>
<p>看了一遍各种策略具体实现，貌似没什么好说的。有兴趣可以直接看motan源代码。</p>
<p>下面贴出一个另外一种的实现，仅供学习参考，<code>非线程安全</code>，使用时需要注意.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalance</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cw = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] weight;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadBalance</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.count = count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadBalance</span><span class="params">(<span class="keyword">int</span>[] weight)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.count = weight.length;</div><div class="line">        <span class="keyword">this</span>.weight = weight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashIndex</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> hash = <span class="number">5381L</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> index;</div><div class="line">        <span class="keyword">for</span>(index = <span class="number">0</span>; index &lt; key.length(); ++index) &#123;</div><div class="line">            hash = (hash &lt;&lt; <span class="number">5</span>) + hash + (<span class="keyword">long</span>)key.charAt(index);</div><div class="line">            hash &amp;= <span class="number">4294967295L</span>;</div><div class="line">        &#125;</div><div class="line">        index = (<span class="keyword">int</span>)hash % <span class="keyword">this</span>.count;</div><div class="line">        index = Math.abs(index);</div><div class="line">        <span class="keyword">return</span> index;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">roundIndexByWeight</span><span class="params">()</span> </span>&#123;</div><div class="line">        do &#123;</div><div class="line">            <span class="keyword">this</span>.i = (<span class="keyword">this</span>.i + <span class="number">1</span>) % <span class="keyword">this</span>.count;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.i == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">this</span>.cw -= <span class="keyword">this</span>.gcd();</div><div class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.cw &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.cw = <span class="keyword">this</span>.max();</div><div class="line">                    <span class="keyword">if</span>(<span class="keyword">this</span>.cw == <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">while</span>(<span class="keyword">this</span>.weight[<span class="keyword">this</span>.i] &lt; <span class="keyword">this</span>.cw);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.i;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">roundIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> j = <span class="keyword">this</span>.i;</div><div class="line">        j = (j + <span class="number">1</span>) % <span class="keyword">this</span>.count;</div><div class="line">        <span class="keyword">this</span>.i = j;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.i;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">gcd</span><span class="params">()</span> </span>&#123;</div><div class="line">        BigInteger value = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.weight.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            value = BigInteger.valueOf((<span class="keyword">long</span>)<span class="keyword">this</span>.weight[<span class="keyword">this</span>.i]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.weight.length - <span class="number">1</span>; ++i) &#123;</div><div class="line">            BigInteger tmp = BigInteger.valueOf((<span class="keyword">long</span>)<span class="keyword">this</span>.weight[i]);</div><div class="line">            tmp = tmp.gcd(BigInteger.valueOf((<span class="keyword">long</span>)<span class="keyword">this</span>.weight[i + <span class="number">1</span>]));</div><div class="line">            <span class="keyword">if</span>(value.compareTo(tmp) &gt; <span class="number">0</span>) &#123;</div><div class="line">                value = tmp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != value) &#123;</div><div class="line">            <span class="keyword">return</span> value.intValue();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">max</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.weight.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            value = <span class="keyword">this</span>.weight[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.weight.length - <span class="number">1</span>; ++i) &#123;</div><div class="line">            <span class="keyword">int</span> tmp = <span class="keyword">this</span>.weight[i];</div><div class="line">            <span class="keyword">if</span>(value &lt; tmp) &#123;</div><div class="line">                value = tmp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HALBProxy</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> HALBProxy.Strategy strategy;</div><div class="line">    <span class="keyword">private</span> LoadBalance lb;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HALBProxy</span><span class="params">(HALBProxy.Strategy strategy)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.logger = Logger.getLogger(<span class="keyword">this</span>.getClass());</div><div class="line">        <span class="keyword">this</span>.availServers = <span class="keyword">new</span> CopyOnWriteArrayList();</div><div class="line">        <span class="keyword">this</span>.unavailServers = <span class="keyword">new</span> CopyOnWriteArrayList();</div><div class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> HashSet();</div><div class="line">        <span class="keyword">this</span>.strategy = strategy;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span>(strategy) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.lb.roundIndex();</div><div class="line">        <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.lb.roundIndexByWeight();</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.lb.hashIndex(key);</div><div class="line">    &#125;</div><div class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> Strategy &#123;</div><div class="line">        DEFAULT,</div><div class="line">        RR,</div><div class="line">        WRR,</div><div class="line">        HASH;</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Strategy</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>总的来说负载均衡部分还算比较简单，LocalFirst优先读取本机的服务这个策略还是很不错的。</p>
<hr>
<p>关于更多loadbalance请看<a href="http://tutorials.jenkov.com/software-architecture/load-balancing.html" target="_blank" rel="external">老外的文章(直戳loadbalance本质)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Motan源码解读/">Motan源码解读</a>
</div>


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/IM开发日记/" title="IM开发日记">IM开发日记<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Motan源码解读/" title="Motan源码解读">Motan源码解读<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/cache/" title="cache">cache<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/并发编程/" title="并发编程">并发编程<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  

  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="DempeZheng">DempeZheng</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
