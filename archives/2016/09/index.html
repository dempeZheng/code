<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive: 2016/9
  
</title>

<meta name="description" content="請更固執，將自己謀生與擅長的事情做到最好">
<meta property="og:type" content="website">
<meta property="og:title" content="郑大侠的博客">
<meta property="og:url" content="http://code.zhizus.com/archives/2016/09/index.html">
<meta property="og:site_name" content="郑大侠的博客">
<meta property="og:description" content="請更固執，將自己謀生與擅長的事情做到最好">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="郑大侠的博客">
<meta name="twitter:description" content="請更固執，將自己謀生與擅長的事情做到最好">


  <link rel="alternative" href="/atom.xml" title="郑大侠的博客" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body
  
    class="monochrome"
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">郑大侠的博客</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">郑大侠的博客</a></h1>
    
      <p class="subtitle">
        DempeZheng&#39;S Blog
      </p>
    
    <div class="info">
      <div class="content">
        
          <div class="description">請更固執，將自己謀生與擅長的事情做到最好</div>
        
        
          <div class="author">DempeZheng</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://cn.gravatar.com/avatar/35fef74d731255cd569c2c2b0b9e87e4?s=200"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IM开发日记/">IM开发日记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cache/">cache</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发编程/">并发编程</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">15</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/denjones/hexo-theme-chan" title="Chan" target="_blank" rel="external">Chan</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/denjones" title="Github" target="_blank" rel="external">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2016" class="archive-year">2016</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-23-motan-rpc.html" >
  深入浅出Motan RPC
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-23-motan-rpc.html"><span class="article-date">
  2016-09-23
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <p>深入浅出Motan RPC</p>
<p><strong>目录</strong></p>
<ul>
<li>TOC<br>{:toc}</li>
</ul>
<h3 id="motan"><a href="#motan" class="headerlink" title="motan"></a>motan</h3><h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>本系列文章假设你已经阅读过motan的官方wiki，对motan或者dubbo有一定的了解。对于没有读过wiki的请先阅读<a href="https://github.com/weibocom/motan/wiki/zh_userguide" target="_blank" rel="external">官方wiki</a>。</p>
<hr>
<blockquote>
<p><code>Motan</code>是一套基于java开发的<code>RPC框架</code>，除了常规的点对点调用外，Motan还提供<code>服务治理功能</code>，包括服务节点的自动发现、摘除、高可用和负载均衡等。Motan具有良好的扩展性，主要模块都提供了多种不同的实现，例如支持多种注册中心，支持多种rpc协议等。</p>
</blockquote>
<p><strong>motan定义为一个RPC框架，首先我们看一下RPC的定义：</strong></p>
<blockquote>
<p><code>RPC</code> 的全称是 <code>Remote Procedure Call</code> 是一种进程间通信方式。 它允许程序调用另一个地址空间（通常是共享网络的另一台机器上）的过程或函数，而不用程序员显式编码这个远程调用的细节。<strong>即程序员无论是调用本地的还是远程的函数，本质上编写的调用代码基本相同</strong>。</p>
</blockquote>
<p>RPC本质上要屏蔽远程调用和本地调用的差异性。</p>
<h4 id="motan的架构"><a href="#motan的架构" class="headerlink" title="motan的架构"></a>motan的架构</h4><p><img src="/images/motan/motan-frame.png" alt="Alt text"></p>
<h4 id="motan分层："><a href="#motan分层：" class="headerlink" title="motan分层："></a>motan分层：</h4><p>motan的分层还是比较清晰，可以分为如下六层：</p>
<ul>
<li><p>Registy 服务发现</p>
<blockquote>
<p>服务的注册和发现功能，motan目前实现了两种，zookeeper，consul</p>
</blockquote>
</li>
<li><p>Config 配置层</p>
<blockquote>
<p>主要提供了配置读取，解析，实体生成。同时他也是整个框架的入口。</p>
</blockquote>
</li>
<li><p>Proxy 代理层</p>
<blockquote>
<p>仅客户端有这一层，基于jdk的动态代理。通过InvocationHandler拦截调用，在客户端调用方法前，将调用交给Cluster来处理。</p>
</blockquote>
</li>
<li><p>Cluster </p>
<blockquote>
<p>提供了服务容灾和负载均衡的能力</p>
</blockquote>
</li>
<li><p>Protocol</p>
<blockquote>
<p>通讯层，提供了暴露服务和获取引用的能力。目前仅仅实现了motan协议和injvm协议</p>
</blockquote>
</li>
<li><p>Transport 传输层</p>
<blockquote>
<p>motan的传输层是基于netty封装实现的。</p>
</blockquote>
</li>
</ul>
<h4 id="motan的一些重要概念"><a href="#motan的一些重要概念" class="headerlink" title="motan的一些重要概念"></a>motan的一些重要概念</h4><ul>
<li><p>Provider</p>
<blockquote>
<p>服务提供方，通常可以认为是server端</p>
</blockquote>
</li>
<li><p>Exporter</p>
<blockquote>
<p>服务提供Provider暴露出去就变成Exporter，服务使用方（客户端）可以调用暴露出去的Provider</p>
</blockquote>
</li>
<li><p>Referer</p>
<blockquote>
<p>引用服务，引用的服务会通过配置去调用服务端暴露的服务</p>
</blockquote>
</li>
</ul>
<h4 id="从Caller调用说起"><a href="#从Caller调用说起" class="headerlink" title="从Caller调用说起"></a>从Caller调用说起</h4><p>motan本质上还是一个RPC服务，RPC的本质是实现无差别的调用远程服务。所以，优雅的RPC应该是无论是服务端还是客户端调用都自同一个接口。<br>对于motan，这个接口就是Caller中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Response call(Request request);</div></pre></td></tr></table></figure>
<p><img src="/images/motan/caller.png" alt="Alt text"></p>
<p>实现Caller接口的主要可以分为一下三类：</p>
<ul>
<li><p>Referer</p>
<blockquote>
<p>作为客户端服务的引用，必须有call的能力。</p>
</blockquote>
</li>
<li><p>Provider</p>
<blockquote>
<p>作为服务端暴露服务的provider，故也需事先caller</p>
</blockquote>
</li>
<li><p>Cluster</p>
<blockquote>
<p>客户端在调用前服务后先通过proxy调用Cluster.call（），然后Cluster.call()调用真正的referer.call(),这里Cluster应用了代理模式，在调用前做了一层代理，提供了负载均衡和容错的能力。</p>
</blockquote>
</li>
</ul>
<h4 id="一个request到一个response的过程"><a href="#一个request到一个response的过程" class="headerlink" title="一个request到一个response的过程"></a>一个request到一个response的过程</h4><p><img src="/images/motan/call-motan.png" alt="Alt text"></p>
<p>首先我们通过RefererConfig获取一个客户端调用Service的Proxy，当我们在客户端执行service的方法时，Proxy就会InvokeHandler就会拦截到执行其invoke方法。<br>在执行invoke的时候，我们会调用Cluster.call()方法，而cluster.call()，实际上是一个代理(这个代理主要是用来处理集群功能的，容灾和负载均衡)，真正执行的是Referer.call()<br>referer是一个服务的引用（我们可以理解为他引用了一个调用特定的provider的client），referer.call()会将request消息编码打包，通过netty tcp长连接传输到服务端（在referer.call()调用的时候其实motan用了装饰模式，经过了filter层，对所有的调用做了一层过滤），<br>服务端收到了Request会对其进行解码，并根据协议body里面穿的interfaceName&amp;methodName&amp;parameterDesc（或者是方法签名）找到对应的provider，并执行，获取返回结果Resonse<br>并将response编码传输返回给客户端。</p>
<h4 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h4><p>上面我们已经看到Referer&amp;Provider的重要性，他是服务提供方和服务的引用方。可以说是整个motan RPC最重要的地方之一。那么Referer&amp;Provider分别是在哪里构造的呢？</p>
<p>这个时候我们需要看Protocol了.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Spi</span>(scope = Scope.SINGLETON)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 暴露服务</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> provider</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 引用服务</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> clz</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@param</span> serviceUrl</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;pre&gt;</div><div class="line">	 * 		1） exporter destroy</div><div class="line">	 * 		2） referer destroy</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从protocol的接口我们看到，他提供了暴露服务的方法，提供了获取引用的方法。<br>如果需要详细了解motan的Protocol，请穿越<a href="http://zhizus.com/code/motan-protocol" target="_blank" rel="external">Motan源码解读-Protocol</a></p>
<h4 id="transport"><a href="#transport" class="headerlink" title="transport"></a>transport</h4><h5 id="传输协议header："><a href="#传输协议header：" class="headerlink" title="传输协议header："></a>传输协议header：</h5><table style="border-collapse:collapse;border-spacing:0;border-color:#999"><tr><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4;text-align:center" colspan="7">header</th></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">0-15</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">16-23</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">24-31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">32-95</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">96-127</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">magic</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">version</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">extend flag</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">request id</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">body content length</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">魔数</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">协议版本</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">24-28</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">29-30</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>消息id<br></td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>body包长</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">保留</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">event( 可支持4种event，<br>如normal, exception等)</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">0 is request , 1 is response</td></tr></table>


<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><h4 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h4><p><a href="http://kriszhang.com/motan-rpc-impl/" target="_blank" rel="external">从motan看RPC框架设计</a>（写的不错）</p>
<hr>
<p>后记：</p>
<p>到目前为止，motan的源代码已经读的七七八八了。个人比较喜欢的点如下：</p>
<ul>
<li>1.精简而灵活，到处都留下了扩展的入口。</li>
<li>2.motan代码读起来顺畅，分层清晰，整体设计还是比较优雅。</li>
</ul>
<p>下面重点说一下不喜欢的：</p>
<ul>
<li>1.motan的codec的实现不太喜欢，这块应该还可以实现的更好。</li>
<li>2.不支持跨语言，如果要扩展为自己的协议，代价比较大。</li>
<li>3.netty的版本有点旧</li>
</ul>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-23-motan-codec.html" >
  Motan源码解读-codec
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-23-motan-codec.html"><span class="article-date">
  2016-09-23
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <p>motan的codec负责rpc框架通讯协议的编解码。codec模块是每个rpc必备的模块，一个设计良好的codec关系到rpc框架编解码的性能和对不同协议的扩展。</p>
<p>dubbo支持http,thrift,dubbo,rmi,webservice,redis等等协议，而motan目前仅支持默认motan的协议，所以很多时候我们可能会扩展motan支持自己的协议，那么我们就得从codec入手了（有的时候甚至还会涉及到protocol）。</p>
<p>codec的类图如下：</p>
<p><img src="/images/motan/codec.png" alt="Alt text"></p>
<p>下面 codec interface的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可基于spi扩展</span></div><div class="line"><span class="meta">@Spi</span>(scope=Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Codec</span> </span>&#123;</div><div class="line">	<span class="comment">// channel为motan定义的channel，非netty的channel</span></div><div class="line">	<span class="keyword">byte</span>[] encode(Channel channel, Object message) <span class="keyword">throws</span> IOException;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> channel</div><div class="line">	 * <span class="doctag">@param</span> remoteIp 用来在server端decode request时能获取到client的ip。</div><div class="line">	 * <span class="doctag">@param</span> buffer</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="comment">// 不明白为什么要把remoteIp定义到decode接口里面，channel里面已经包含ip的信息了</span></div><div class="line">	<span class="function">Object <span class="title">decode</span><span class="params">(Channel channel, String remoteIp, <span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractCodec里面实现了创建输入输出流的方法，用来将协议序列化成字节数组或将字节数组反序列化成协议的。（这种方式的性能还没压测，不知道好坏）</p>
<p>如果我们要实现自己的协议，可以仅仅实现codec的方法。</p>
<p>实现AbstractCodec的有三个类</p>
<ul>
<li>DefaultRpcCodec</li>
</ul>
<blockquote>
<p>默认的协议编解码实现</p>
</blockquote>
<ul>
<li>MockDefaultRpcCodec</li>
</ul>
<blockquote>
<p>用于测试的</p>
</blockquote>
<ul>
<li>CompresssRpcCodec</li>
</ul>
<blockquote>
<p>经过压缩的协议编解码实现</p>
</blockquote>
<p>为了不引入复杂性，我们先看DefaultRpcCodec的实现。<br>要知道motan如何对协议编解码，首先我们的非常清楚motan的协议格式。</p>
<p>CompresssRpcCodec这个类的注释中已经有协议各个模块的实现，但是还不够清晰简明，我们先整理一个图。</p>
<h4 id="motan协议格式"><a href="#motan协议格式" class="headerlink" title="motan协议格式"></a>motan协议格式</h4><ul>
<li>header</li>
</ul>
<table style="border-collapse:collapse;border-spacing:0;border-color:#999"><tr><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4;text-align:center" colspan="7">header</th></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">0-15</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">16-23</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">24-31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">32-95</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">96-127</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">magic</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center">version</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" colspan="3">extend flag</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">request id</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">body content length</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">魔数</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center" rowspan="2">协议版本</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">24-28</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">29-30</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">31</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>消息id<br></td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top" rowspan="2"><br>body包长</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">保留</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">event( 可支持4种event，<br>如normal, exception等)</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;text-align:center;vertical-align:top">0 is request , 1 is response</td></tr></table>


<ul>
<li>request body</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/* </span></div><div class="line">   * &lt;pre&gt;</div><div class="line">* </div><div class="line">* 	 body:</div><div class="line">* </div><div class="line">* 	 byte[] data :  </div><div class="line">* </div><div class="line">* 			serialize(interface_name, method_name, method_param_desc, method_param_value, attachments_size, attachments_value) </div><div class="line">* </div><div class="line">*   method_param_desc:  for_each (string.append(method_param_interface_name))</div><div class="line">* </div><div class="line">*   method_param_value: for_each (method_param_name, method_param_value)</div><div class="line">* </div><div class="line">* 	 attachments_value:  for_each (attachment_name, attachment_value)</div><div class="line">* </div><div class="line">* &lt;/pre&gt;</div><div class="line">   * </div><div class="line">   * @param request</div><div class="line">   * @return</div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">byte</span>[] encodeRequest(Channel channel, Request request) <span class="keyword">throws</span> IOException ;</div></pre></td></tr></table></figure>
<p>encodeRequest方法的注释很清晰的描述了request 的body部分的序列化，对jvm系列的来说非常友好，基本上把调用相关所有能用到的信息都序列化了。</p>
<p>我们可以把请求任何一个请求参数都反序列化java对象。所以motan默认的协议是可以支持方法内参数为java任意对象。<br>但是，<code>对于其他语言就不太友好了</code>。其他语言不太容易序列化java的对象。<br>如果希望更好的支持其他的语言，这个请求参数的类型序列化方式可能有所取舍了。</p>
<ul>
<li>response body</li>
</ul>
<blockquote>
<p><code>serialize (result) or serialize (exception)</code>：motan的response的message对象是通过hession2或者fastjson序列化生成的字节数组，所以这个地方就是一个字节数组（如果需要了解序列化的部分，可以看上篇博客）</p>
</blockquote>
<h4 id="motan协议打包"><a href="#motan协议打包" class="headerlink" title="motan协议打包"></a>motan协议打包</h4><p>协议的打包简单说一下header打包的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] encode(<span class="keyword">byte</span>[] body, <span class="keyword">byte</span> flag, <span class="keyword">long</span> requestId) <span class="keyword">throws</span> IOException &#123;</div><div class="line">      <span class="comment">// 协议1的header占16个字节，先创建一个长度为16的字节数组</span></div><div class="line">      <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[RpcProtocolVersion.VERSION_1.getHeaderLength()];</div><div class="line">      <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 0 - 15 bit : magic</span></div><div class="line">      <span class="comment">// 这个方法实际上是把short类型的magic转成两个字节，打包到header</span></div><div class="line">      ByteUtil.short2bytes(MAGIC, header, offset);</div><div class="line">      offset += <span class="number">2</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 16 - 23 bit : version</span></div><div class="line">      <span class="comment">// 打包version</span></div><div class="line">      header[offset++] = RpcProtocolVersion.VERSION_1.getVersion();</div><div class="line"></div><div class="line">      <span class="comment">// 24 - 31 bit : extend flag</span></div><div class="line">      <span class="comment">// 打包flag</span></div><div class="line">      header[offset++] = flag;</div><div class="line"></div><div class="line">      <span class="comment">// 32 - 95 bit : requestId</span></div><div class="line">      <span class="comment">// 打包requestId</span></div><div class="line">      ByteUtil.long2bytes(requestId, header, offset);</div><div class="line">      offset += <span class="number">8</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 96 - 127 bit : body content length</span></div><div class="line">      <span class="comment">// 打包body包长</span></div><div class="line">      ByteUtil.int2bytes(body.length, header, offset);</div><div class="line"></div><div class="line">      <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[header.length + body.length];</div><div class="line"></div><div class="line">      System.arraycopy(header, <span class="number">0</span>, data, <span class="number">0</span>, header.length);</div><div class="line">      System.arraycopy(body, <span class="number">0</span>, data, header.length, body.length);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> data;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>到这里motan默认的协议基本分析完，但是还没说到CompresssRpcCodec 压缩的编解码，（这个压缩的类跟协议编解码写到一起，分离出来会不会更好[如果我们能确定哪些地方需要压缩]）</p>
<h4 id="motan协议的压缩"><a href="#motan协议的压缩" class="headerlink" title="motan协议的压缩"></a>motan协议的压缩</h4><p>数据压缩也是一个完善的rpc框架必备的功能之一，良好的压缩可以减少网络传输数据大小，节省流量，提升响应速度。</p>
<h5 id="压缩算法比较"><a href="#压缩算法比较" class="headerlink" title="压缩算法比较"></a>压缩算法比较</h5><p>以下是Google几年前发布的一组测试数据（数据有些老了，有人近期做过测试的话希望能共享出来）：</p>
<table style="border-collapse:collapse;border-spacing:0;border-color:#999"><tr><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">Algorithm</th><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">% remaining</th><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">Encoding</th><th style="font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4">Decoding</th></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">GZIP</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">13.4%</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">21 MB/s</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">118 MB/s</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">LZO</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">20.5%</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">135 MB/s</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">410 MB/s</td></tr><tr><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">Zippy/Snappy</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">22.2%</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">172 MB/s</td><td style="font-family:Arial, sans-serif;font-size:14px;padding:10px 20px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA">409 MB/s</td></tr></table>



<p>注：来自《HBase: The Definitive Guide》<br>其中：</p>
<p>1）GZIP的压缩率最高，但是其实CPU密集型的，对CPU的消耗比其他算法要多，压缩和解压速度也慢；</p>
<p>2）LZO的压缩率居中，比GZIP要低一些，但是压缩和解压速度明显要比GZIP快很多，其中解压速度快的更多；</p>
<p>3）Zippy/Snappy的压缩率最低，而压缩和解压速度要稍微比LZO要快一些。</p>
<h4 id="motan中的协议压缩"><a href="#motan中的协议压缩" class="headerlink" title="motan中的协议压缩"></a>motan中的协议压缩</h4><p>motan默认支持的压缩是gzip，这块代码比较杂，不支持扩展，如果要实现自己的压缩方式，得重新实现codec部分（继承defaultRpcCodec，重写部分方法也可以）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 对rpc body进行压缩。</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] compress(<span class="keyword">byte</span>[] org, <span class="keyword">boolean</span> useGzip, <span class="keyword">int</span> minGzSize) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">if</span> (useGzip &amp;&amp; org.length &gt; minGzSize) &#123;</div><div class="line">            ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">            GZIPOutputStream gos = <span class="keyword">new</span> GZIPOutputStream(outputStream);</div><div class="line">            gos.write(org);</div><div class="line">            gos.finish();</div><div class="line">            gos.flush();</div><div class="line">            gos.close();</div><div class="line">            <span class="keyword">byte</span>[] ret = outputStream.toByteArray();</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> org;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>就不一一分析motan这块代码，简单总结一下motan compress：</p>
<p>1）motan压缩的仅仅是rpc 的body部分。header没有压缩的必要。</p>
<p>2）心跳包没有body，不压缩。</p>
<p>3） mingzSize(“mingzSize”, 1000), // 进行gz压缩的最小数据大小。超过此阈值才进行gz压缩</p>
<p>4）usegz(“usegz”, false), // 是否开启gzip压缩，这个可以配置</p>
<p>5）是否开启压缩usegz这个是通过配置来约定的，并未发现有打包到协议里面。如果要解包，首先要知道这个协议是否压缩过。（个人感觉这里不太好，对于motan自己client调用将配置文件拷贝过去即可，但是对于其他的语言就麻烦了，不太友好）</p>
<h4 id="方法签名"><a href="#方法签名" class="headerlink" title="方法签名"></a>方法签名</h4><p>motan在打包method的时候会对根据方法的interfaceName，methodName，parameterDes拼接起来，md5生成一个方法签名，如果方法签名生成成功，则将方法签名的标志和方法签名打包，否则打包完整的方法信息</p>
<p>如果客户端使用了方法签名，服务端怎么这个方法签名是哪一个方法呢？（首先生成签名的方法是md5的不可逆的，也就是说不可以反解。）</p>
<p>motan的做法是每个服务在export前都会对对应的方法生成签名，并保存签名和方法的映射。</p>
<p>方法签名的好处：最大的好处就是省了流量。也可以带来一点点性能提升。</p>
<hr>
<p>后记：</p>
<p>motan的设计基本没考虑跨语言的调用。有些可惜。</p>
<p>个人并不是很喜欢motan codec的代码，故不会在这里耗太多时间。<br>以后遇到好的codec的代码，再来分享。</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-22-motan-serialize.html" >
  Motan源码解读-serialize
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-22-motan-serialize.html"><span class="article-date">
  2016-09-22
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <h3 id="motan-序列化"><a href="#motan-序列化" class="headerlink" title="motan 序列化"></a>motan 序列化</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><blockquote>
<p><strong>序列化：</strong> 将数据结构或对象转换成二进制串的过程。<br><strong>反序列化：</strong>将在序列化过程中所生成的二进制串转换成数据结构或者对象的过程。</p>
</blockquote>
<p>motan 将RPC<code>请求中的参数、结果等对象进行序列化与反序列化</code>，即进行对象与字节流的互相转换；默认使用对java更友好的hessian2进行序列化。（注意序列化的是请求的参数，和返回的结果，其他的地方不需要序列化）</p>
<p>一个rpc框架的性能主要取决于：线程模型，IO模型，序列化三个方面。（对于有gc机制的jvm来说，零拷贝也很关键）<br>所以一个性能优异的序列化对于rpc是非常重要的。（这里的序列化和反序列化仅仅涉及到请求中的参数、结果等对象，协议其他的信息的序列化见后续的codec章节）</p>
<p>motan会对client端发送的request的请求参数对象进行序列化，也会对服务端下发给response对象进行序列化，如下图所示：</p>
<p><img src="/code/images//motan/motan-register-server-client.jpg" alt=""></p>
<h4 id="motan目前支持两种序列化："><a href="#motan目前支持两种序列化：" class="headerlink" title="motan目前支持两种序列化："></a>motan目前支持两种序列化：</h4><ul>
<li>hession2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol serialization=&quot;hessian2&quot; /&gt;</div></pre></td></tr></table></figure>
<ul>
<li>fastjson</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol serialization=&quot;fastjson&quot; /&gt;</div></pre></td></tr></table></figure>
<h3 id="各种序列化性能对比"><a href="#各种序列化性能对比" class="headerlink" title="各种序列化性能对比"></a>各种序列化性能对比</h3><p><img src="/images/motan/serialize.png" alt=""></p>
<p>我们可以发现fastjson的序列化性能和thrift和protobuf差异已经不太大了，明显好过hession（当然上图比较的不知道hession的版本，可能不准确）<br>dubbo是有针对hession单独做优化的，但是motan默认使用hession，且没做优化。</p>
<h3 id="motan序列化的实现"><a href="#motan序列化的实现" class="headerlink" title="motan序列化的实现"></a>motan序列化的实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个可以可以扩展的，也就是你可以扩展motan用你想要的序列化方式</span></div><div class="line"><span class="meta">@Spi</span>(scope=Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line">	<span class="comment">// 将对象序列话称字节数组</span></div><div class="line">	<span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException;</div><div class="line">	<span class="comment">// 将字节数组反序列化成对象</span></div><div class="line">	&lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; clz)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体的实现要看hession2和fastjson了。</p>
<p>motan序列化&amp;反序列化仅仅包含了请求参数和返回对象，其他对象的编解码，我们且看下一篇文章。</p>
<hr>
<p>后记：</p>
<p>1.fastjson确实够快，使用也挺方便的。</p>
<p>2.如果我们需要扩展motan实现thrift或者protobuf还需要hession或者fastjson来辅助序列化吗？</p>
<p>首先hession可以排除，使用hession跨语言调用就比较难实现了。<br>那么需要辅助的fastjson来序列化吗？没必要。</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-21-motan-filter.html" >
  Motan源码解读-Filter
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-21-motan-filter.html"><span class="article-date">
  2016-09-21
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <p>很多服务都有filter这个概念，filter就像在管道前的过滤器，只要通过管道的请求必须先经过过滤器。<br>过滤器可以做很多事情，类似权限控制，限流，统计，上报，监控等等。有些为服务架构会把filter单独抽出来作为getway服务。</p>
<h3 id="motan-filter："><a href="#motan-filter：" class="headerlink" title="motan filter："></a>motan filter：</h3><h4 id="目前实现的filter"><a href="#目前实现的filter" class="headerlink" title="目前实现的filter"></a>目前实现的filter</h4><ul>
<li>AccessLogFilter</li>
</ul>
<blockquote>
<p>统计整个call的执行状况，尽量到最上层，最后执行.<br>此filter会对性能产生一定影响，请求量较大时建议关闭。</p>
</blockquote>
<ul>
<li>AccessStatisticFilter</li>
</ul>
<p>&gt;</p>
<ul>
<li>ActiveLimitFilter</li>
</ul>
<blockquote>
<p>limit active count，判断某个接口并发数是否超限，如果超过限制，则上抛异常,同时做简单的统计。 此filter比较严格，尽量放到底层较早执行。</p>
</blockquote>
<ul>
<li>ServiceMockFilter</li>
</ul>
<blockquote>
<p>mock serivce。测试场景使用</p>
</blockquote>
<ul>
<li>SwitcherFilter</li>
</ul>
<blockquote>
<p>服务降级的filter，</p>
</blockquote>
<h4 id="按使用的地方划分"><a href="#按使用的地方划分" class="headerlink" title="按使用的地方划分"></a>按使用的地方划分</h4><ul>
<li><strong>服务端的filter</strong></li>
<li><strong>客户端的filter</strong></li>
</ul>
<p>motan的服务端和客户端都可以添加filter，可以是相同的filter也可以是不同的filter</p>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>下面我们来看filter的ProtocolFilterDecorator 代码(代码仅保留了分析相关部分)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolFilterDecorator</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">decorateWithFilter</span><span class="params">(Referer&lt;T&gt; referer, URL url)</span> </span>&#123;</div><div class="line">        List&lt;Filter&gt; filters = getFilters(url, MotanConstants.NODE_TYPE_REFERER);</div><div class="line">        Referer&lt;T&gt; lastRef = referer;</div><div class="line">        <span class="keyword">for</span> (Filter filter : filters) &#123;</div><div class="line">            <span class="keyword">final</span> Filter f = filter;</div><div class="line">            <span class="keyword">final</span> Referer&lt;T&gt; lf = lastRef;</div><div class="line">            lastRef = <span class="keyword">new</span> Referer&lt;T&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">	                <span class="comment">// 这里可以通过配置来控制，对于重试的请求要不要经过filter，比如有些安全校验的，第一次已经校验通过，重试自然不用在校验一次，但是对于有些统计来说，可能会认为不管是不是重试，都需要统计，这里通过配置把这种情况暴露给使用者，把决定权留给使用方</span></div><div class="line">                    <span class="keyword">if</span> (!f.getClass().getAnnotation(Activation.class).retry() &amp;&amp; request.getRetries() != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> lf.call(request);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> f.filter(lf, request);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">               ...</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> lastRef;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">Provider&lt;T&gt; <span class="title">decorateWithFilter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">        List&lt;Filter&gt; filters = getFilters(url, MotanConstants.NODE_TYPE_SERVICE);</div><div class="line">        <span class="keyword">if</span> (filters == <span class="keyword">null</span> || filters.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> provider;</div><div class="line">        &#125;</div><div class="line">        Provider&lt;T&gt; lastProvider = provider;</div><div class="line">        <span class="keyword">for</span> (Filter filter : filters) &#123;</div><div class="line">            <span class="keyword">final</span> Filter f = filter;</div><div class="line">            <span class="keyword">final</span> Provider&lt;T&gt; lp = lastProvider;</div><div class="line">            lastProvider = <span class="keyword">new</span> Provider&lt;T&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> f.filter(lp, request);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ...</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> lastProvider;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这个类的名字我们可以可以猜测motan的filter是基于java的<code>装饰模式</code>了，关于java的装饰者模式，（最经典的是jdk的IO部分的用法）</p>
<blockquote>
<p><strong>装饰模式：</strong>在不必改变原类文件和使用继承的情况下，动态地扩展一个对象的功能。它是通过创建一个包装对象，也就是装饰来包裹真实的对象。</p>
</blockquote>
<p>这个类中包装了两个filter，一个是把客户端的referer decorateWithFilter，另一个是把服务端的Provider decorateWithFilter。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>对于filter，作用大多是过滤，一般越早越好，如果不满足过滤条件，能够早些丢弃，不会浪费资源对那些不满足filter过滤条件的请求做其他的处理。</p>
<p>所以一般encode&amp;decode完成的请求会立即进到filter过滤。</p>
<hr>
<p>后记：后面会补充</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-21-motan-override.html" >
  Motan源码解读-源码结构
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-21-motan-override.html"><span class="article-date">
  2016-09-21
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <p>旨在对motan包结构熟悉，顺带会根据包结构列出系列文章的索引。</p>
<h3 id="motan包结构"><a href="#motan包结构" class="headerlink" title="motan包结构"></a>motan包结构</h3><pre><code>motan-benchmark // 压测相关
motan-core    //motan核心代码，也是源码解析的主要包
motan-demo    // 示例，快速上手的最佳方法
motan-extension // 扩展
motan-manager // 管理后台
motan-registry-consul    //基于consul的服务发现实现
motan-registry-zookeeper // 基于zookeeper的服务发现实现
motan-springsupport // spring容器的支持，也支持springboot
motan-transport-netty // netty传输的封装
</code></pre><h4 id="motan-core"><a href="#motan-core" class="headerlink" title="motan-core"></a>motan-core</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">└─com</div><div class="line">    └─weibo</div><div class="line">        └─api</div><div class="line">            └─motan</div><div class="line">                ├─cluster</div><div class="line">                │  ├─ha //①容灾策略</div><div class="line">                │  ├─loadbalanc //②负载均衡</div><div class="line">                │  └─support</div><div class="line">                ├─codec //③编解码</div><div class="line">                ├─common</div><div class="line">                ├─config //④配置</div><div class="line">                │  ├─annotation</div><div class="line">                │  └─handler</div><div class="line">                ├─core</div><div class="line">                │  └─extension //⑤ SPI机制扩展</div><div class="line">                ├─exception // ⑥异常</div><div class="line">                ├─filter //⑦过滤器</div><div class="line">                ├─log //⑧日志</div><div class="line">                ├─protocol //⑨责点到点的通讯(有别于我们理解的protocol)</div><div class="line">                │  ├─injvm</div><div class="line">                │  ├─rpc</div><div class="line">                │  └─support</div><div class="line">                ├─proxy //⑩代理</div><div class="line">                │  └─spi</div><div class="line">                ├─registry //⑪服务注册</div><div class="line">                │  └─support</div><div class="line">                │      └─comman</div><div class="line">                ├─rpc</div><div class="line">                ├─serialize //⑫序列化</div><div class="line">                ├─switcher</div><div class="line">                ├─transport</div><div class="line">                │  └─support</div><div class="line">                └─util</div></pre></td></tr></table></figure>
<p>这个包是motan的核心实现，里面的大部分代码，接下的文章都会涉及到。</p>
<p>①<a href="http://zhizus.com/code/motan-hastratege" target="_blank" rel="external">motan-容灾策略</a></p>
<p>②<a href="http://zhizus.com/code/motan-loadbalance" target="_blank" rel="external">motan-负载均衡</a></p>
<p>⑤<a href="http://zhizus.com/code/motan-spi" target="_blank" rel="external">motan-SPI机制扩展</a></p>
<p>⑦<a href="http://zhizus.com/code/motan-filter" target="_blank" rel="external">motan-过滤器</a></p>
<p>⑨<a href="http://zhizus.com/code/motan-protocol" target="_blank" rel="external">motan-protocol</a></p>
<h4 id="motan-transport-netty"><a href="#motan-transport-netty" class="headerlink" title="motan-transport-netty"></a>motan-transport-netty</h4><p>⑨<a href="http://zhizus.com/code/motan-clientMessage" target="_blank" rel="external">motan-netty-client异步消息</a></p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-21-motan-hastratege.html" >
  Motan源码解读-容错策略
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-21-motan-hastratege.html"><span class="article-date">
  2016-09-21
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <h3 id="Motan的容错策略"><a href="#Motan的容错策略" class="headerlink" title="Motan的容错策略"></a>Motan的容错策略</h3><blockquote>
<p>Motan 在集群调用失败时，提供了两种容错方案，并支持自定义扩展。 高可用集群容错策略在Client端生效，因此需在Client端添加配置 目前支持的集群容错策略有：</p>
</blockquote>
<ul>
<li><strong>Failover 失效切换（缺省）</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... haStrategy=&quot;failover&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>失败自动切换，当出现失败，重试其它服务器。</p>
</blockquote>
<ul>
<li><strong>Failfast 快速失败</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... haStrategy=&quot;failfast&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>快速失败，只发起一次调用，失败立即报错。</p>
</blockquote>
<h3 id="dubbo的容错策略"><a href="#dubbo的容错策略" class="headerlink" title="dubbo的容错策略"></a>dubbo的容错策略</h3><p>motan实际上是dubbo的子集，也可以说是阉割版。一下是dubbo支持的容错策略。</p>
<ul>
<li><p><strong>1.failover cluster</strong></p>
<blockquote>
<p>失败自动切换，当出现失败，重试其他服务器（缺省），通常用于读操作，但重试会带来更长的延时，可通过retries=“2”来设置重试次数（不含第一次）</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service retries=&quot;2&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong>2.failfast cluster</strong></li>
</ul>
<blockquote>
<p>快速失效，只发起一次调用，失败立即报错。通常用于非幂等性写操作，比如说新增记录</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;failfast&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p><strong>3.failsaft cluster</strong></p>
<blockquote>
<p>失败安全，出现异常时，直接忽略，通常用于写入审计日志等操作</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;failsafe&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong>4.failback cluster</strong></li>
</ul>
<blockquote>
<p>失败自动恢复，后台记录失败请求，定时重发，通常用于消息通知操作</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;failback&quot;&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p><strong>5.forking cluster</strong></p>
<blockquote>
<p>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多的服务器资源。可通过forks=“2”来设置最大并行数。</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;dubbo:service cluster=&quot;forking&quot;&gt;</div></pre></td></tr></table></figure>
<h3 id="motan容错策略源代码解读"><a href="#motan容错策略源代码解读" class="headerlink" title="motan容错策略源代码解读"></a>motan容错策略源代码解读</h3><p>motan的容错策略尽管支持的不够多，但是对于大部分场景已经够用。而对于一些特殊场景我们可以基于motan 的SPI机制扩展实现自己需要的容错策略。</p>
<p><img src="http://zhizus.com/code/images//motan/14612385789967.jpg" alt="enter image description here"></p>
<p>motan的容错策略及时基于java的<code>策略模式</code>实现的。</p>
<blockquote>
<p>策略模式作为一种软件设计模式，指对象有某个行为，但是在不同的场景中，该行为有不同的实现算法。比如每个人都要“交个人所得税”，但是“在美国交个人所得税”和“在中国交个人所得税”就有不同的算税方法。</p>
</blockquote>
<p>motan容错的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以通过motan的SPI机制扩展</span></div><div class="line"><span class="meta">@Spi</span>(scope = Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HaStrategy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// 从后面的实现来看，没发现有什么用</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(URL url)</span></span>;</div><div class="line">    <span class="comment">//基于具体的LoadBalance调用请求，问答模式，一个request返回一个response，</span></div><div class="line">    <span class="function">Response <span class="title">call</span><span class="params">(Request request, LoadBalance&lt;T&gt; loadBalance)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractHaStrategy这个抽象方法做的事情貌似没什么用，直接看具体的实现：<br>failfast很简单，直接略去。看failover的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpiMeta</span>(name = <span class="string">"failover"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverHaStrategy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractHaStrategy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//确保每个线程持有一份单独的ArrayList&lt;Referer&lt;T&gt;（FailoverHaStrategy，会有单个实例被多个线程调用）</span></div><div class="line">    <span class="keyword">protected</span> ThreadLocal&lt;List&lt;Referer&lt;T&gt;&gt;&gt; referersHolder = <span class="keyword">new</span> ThreadLocal&lt;List&lt;Referer&lt;T&gt;&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">protected</span> java.util.List&lt;com.weibo.api.motan.rpc.Referer&lt;T&gt;&gt; initialValue() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Referer&lt;T&gt;&gt;();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request, LoadBalance&lt;T&gt; loadBalance)</span> </span>&#123;</div><div class="line"></div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = selectReferers(request, loadBalance);</div><div class="line">        <span class="keyword">if</span> (referers.isEmpty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(String.format(<span class="string">"FailoverHaStrategy No referers for request:%s, loadbalance:%s"</span>, request,</div><div class="line">                    loadBalance));</div><div class="line">        &#125;</div><div class="line">        URL refUrl = referers.get(<span class="number">0</span>).getUrl();</div><div class="line">        <span class="comment">// 先使用method的配置</span></div><div class="line">        <span class="keyword">int</span> tryCount =</div><div class="line">                refUrl.getMethodParameter(request.getMethodName(), request.getParamtersDesc(), URLParamType.retries.getName(),</div><div class="line">                        URLParamType.retries.getIntValue());</div><div class="line">        <span class="comment">// 如果有问题，则设置为不重试</span></div><div class="line">        <span class="keyword">if</span> (tryCount &lt; <span class="number">0</span>) &#123;</div><div class="line">            tryCount = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tryCount; i++) &#123;</div><div class="line">            Referer&lt;T&gt; refer = referers.get(i % referers.size());</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                request.setRetries(i);</div><div class="line">                <span class="keyword">return</span> refer.call(request);</div><div class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">                <span class="comment">// 对于业务异常，直接抛出</span></div><div class="line">                <span class="keyword">if</span> (ExceptionUtil.isBizException(e)) &#123;</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i &gt;= tryCount) &#123;</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">                LoggerUtil.warn(String.format(<span class="string">"FailoverHaStrategy Call false for request:%s error=%s"</span>, request, e.getMessage()));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">      <span class="comment">// 从逻辑来看 代码不会到这个地方（如果是业务逻辑直接抛出，如果达到重试次数，也直接抛出异常了二中断了）</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="string">"FailoverHaStrategy.call should not come here!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 先从threadLocal拿到当前线程持有的List&lt;Referer&lt;T&gt;&gt; referers，然后清除，再从loadbalance哪里复制一份最新的引用添加进去</div><div class="line">     * haStratege能感知到引用列表的实时变化</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@param</span> loadBalance</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> List&lt;Referer&lt;T&gt;&gt; selectReferers(Request request, LoadBalance&lt;T&gt; loadBalance) &#123;</div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = referersHolder.get();</div><div class="line">        referers.clear();</div><div class="line">        loadBalance.selectToHolder(request, referers);</div><div class="line">        <span class="keyword">return</span> referers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码花费了些时间理解。</p>
<ul>
<li>1.为什么要将引用放到new ThreadLocal<list<referer<t>&gt;&gt;()?</list<referer<t></li>
</ul>
<blockquote>
<p>首先单个HAStratege会被多个线程调用，加入ThreadLocal必然是为了保证每个线程持有单独的一份refererList。<br>如果没有ThreadLocal，当其他线程调用selectReferers()会改变refererList，这个时候call方法中的循环会有问题，临界条件可能会抛异常。</p>
</blockquote>
<ul>
<li>2.为什么需要selectReferers？</li>
</ul>
<blockquote>
<p>这个方法可以确保referer列表的实时性，能够实时感知到referer列表的变化。</p>
</blockquote>
<h3 id="关于容错的其他考虑"><a href="#关于容错的其他考虑" class="headerlink" title="关于容错的其他考虑"></a>关于容错的其他考虑</h3><p>上文讨论的容错都是基于业务调用方考虑的一些策略。无论是motan还是dubbo都没有基于服务端自身保护的考虑。</p>
<blockquote>
<p>当企业微服务化以后，服务之间会有错综复杂的依赖关系，例如，一个前端请求一般会依赖于多个后端服务。在实际生产环境中，服务往往不是百分百可靠，服务可能会出错或者产生延迟，如果一个应用不能对其依赖的故障进行容错和隔离，那么该应用本身就处在被拖垮的风险中。在一个高流量的网站中，某个单一后端一旦发生延迟，可能在数秒内导致所有应用资源(线程，队列等)被耗尽，造成所谓的雪崩效应(Cascading Failure)，严重时可致整个网站瘫痪。</p>
</blockquote>
<ul>
<li><p><strong>电路熔断器模式(Circuit Breaker Patten),</strong> 该模式的原理类似于家里的电路熔断器，如果家里的电路发生短路，熔断器能够主动熔断电路，以避免灾难性损失。在分布式系统中应用电路熔断器模式后，当目标服务慢或者大量超时，调用方能够主动熔断，以防止服务被进一步拖垮；如果情况又好转了，电路又能自动恢复，这就是所谓的弹性容错，系统有自恢复能力。下图Fig 8是一个典型的具备弹性恢复能力的电路保护器状态图，正常状态下，电路处于关闭状态(Closed)，如果调用持续出错或者超时，电路被打开进入熔断状态(Open)，后续一段时间内的所有调用都会被拒绝(Fail Fast)，一段时间以后，保护器会尝试进入半熔断状态(Half-Open)，允许少量请求进来尝试，如果调用仍然失败，则回到熔断状态，如果调用成功，则回到电路闭合状态。</p>
</li>
<li><p><strong>舱壁隔离模式(Bulkhead Isolation Pattern)</strong>，顾名思义，该模式像舱壁一样对资源或失败单元进行隔离，如果一个船舱破了进水，只损失一个船舱，其它船舱可以不受影响 。线程隔离(Thread Isolation)就是舱壁隔离模式的一个例子，假定一个应用程序A调用了Svc1/Svc2/Svc3三个服务，且部署A的容器一共有120个工作线程，采用线程隔离机制，可以给对Svc1/Svc2/Svc3的调用各分配40个线程，当Svc2慢了，给Svc2分配的40个线程因慢而阻塞并最终耗尽，线程隔离可以保证给Svc1/Svc3分配的80个线程可以不受影响，如果没有这种隔离机制，当Svc2慢的时候，120个工作线程会很快全部被对Svc2的调用吃光，整个应用程序会全部慢下来。</p>
</li>
<li><p><strong>限流(Rate Limiting/Load Shedder)</strong>，服务总有容量限制，没有限流机制的服务很容易在突发流量(秒杀，双十一)时被冲垮。限流通常指对服务限定并发访问量，比如单位时间只允许100个并发调用，对超过这个限制的请求要拒绝并回退。</p>
</li>
<li><p><strong>回退(fallback)</strong>，在熔断或者限流发生的时候，应用程序的后续处理逻辑是什么？回退是系统的弹性恢复能力，常见的处理策略有，直接抛出异常，也称快速失败(Fail Fast)，也可以返回空值或缺省值，还可以返回备份数据，如果主服务熔断了，可以从备份服务获取数据。</p>
</li>
</ul>
<blockquote>
<p>Netflix将上述容错模式和最佳实践集成到一个称为<code>Hystrix</code>的开源组件中，凡是需要容错的依赖点(服务，缓存，数据库访问等)，开发人员只需要将调用封装在Hystrix Command里头，则相关调用就自动置于Hystrix的弹性容错保护之下。Hystrix组件已经在Netflix经过多年运维验证，是Netflix微服务平台稳定性和弹性的基石，正逐渐被社区接受为标准容错组件。</p>
</blockquote>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>容灾策略motan实现的比较简单 ，代码也相对好懂，可以参考借鉴。</p>
<hr>
<p>后记：<br>希望有时间可以看Hystrix的实现，</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-21-motan-protocol.html" >
  Motan源码解读-Protocol
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-21-motan-protocol.html"><span class="article-date">
  2016-09-21
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <p>protocol可以说是motan最重要的部分之一。<br>暴露一个服务引用一个服务都是在这块实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Spi</span>(scope = Scope.SINGLETON)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 暴露服务</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> provider</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 引用服务</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@param</span> clz</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     * <span class="doctag">@param</span> serviceUrl</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;pre&gt;</div><div class="line">	 * 		1） exporter destroy</div><div class="line">	 * 		2） referer destroy</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">     * </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Provider</li>
</ul>
<blockquote>
<p>服务提供方，通常可以认为是server端</p>
</blockquote>
<ul>
<li>Exporter</li>
</ul>
<blockquote>
<p>服务提供Provider暴露出去就变成Exporter，服务使用方（客户端）可以调用暴露出去的Provider</p>
</blockquote>
<ul>
<li>Referer</li>
</ul>
<blockquote>
<p>引用服务，引用的服务会通过配置去调用服务端暴露的服务</p>
</blockquote>
<p>现在我们应该会有一定的认识，对于protocol。不管是暴露服务还是引用服务都是通过protocol来实现的。可以说他是学习motan的一个入口。</p>
<p>我们看到这个接口上面也有@SPI注解，就是说protocol可以基于spi机制扩展，<code>也就说你可以对motan进行为所欲为的扩展</code>。</p>
<h3 id="protocol的实现"><a href="#protocol的实现" class="headerlink" title="protocol的实现"></a>protocol的实现</h3><p><img src="/images/motan/Protocol.png" alt=""></p>
<p>这里面再次用到了<code>模板方法设计模式</code>。</p>
<p>下面看我们看AbstractProtocol抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProtocol</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    <span class="comment">// 存放本地export的服务，用于injvm的时候查找本地服务</span></div><div class="line">    <span class="keyword">protected</span> ConcurrentHashMap&lt;String, Exporter&lt;?&gt;&gt; exporterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Exporter&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Map&lt;String, Exporter&lt;?&gt;&gt; getExporterMap() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(exporterMap);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Error: url is null"</span>,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Error: provider is null, url="</span> + url,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String protocolKey = MotanFrameworkUtil.getProtocolKey(url);</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (exporterMap) &#123;</div><div class="line">            Exporter&lt;T&gt; exporter = (Exporter&lt;T&gt;) exporterMap.get(protocolKey);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (exporter != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Error: service already exist, url="</span> + url,</div><div class="line">                        MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            exporter = createExporter(provider, url);</div><div class="line">            exporter.init();</div><div class="line"></div><div class="line">            exporterMap.put(protocolKey, exporter);</div><div class="line"></div><div class="line">            LoggerUtil.info(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" export Success: url="</span> + url);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> exporter;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> refer(clz, url, url);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" refer Error: url is null"</span>,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (clz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanFrameworkException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" refer Error: class is null, url="</span> + url,</div><div class="line">                    MotanErrorMsgConstant.FRAMEWORK_INIT_ERROR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Referer&lt;T&gt; referer = createReferer(clz, url, serviceUrl);</div><div class="line">        referer.init();</div><div class="line"></div><div class="line">        LoggerUtil.info(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" refer Success: url="</span> + url);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> referer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 用于子类扩展，通过扩展这个方法，可以使服务端暴露出自定义的服务。</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">createExporter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// 用于子类扩展，通过扩展这个方法，可以使客户端有自定义的服务引用。</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">createReferer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String key : exporterMap.keySet()) &#123;</div><div class="line">            Node node = exporterMap.remove(key);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    node.destroy();</div><div class="line"></div><div class="line">                    LoggerUtil.info(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" destroy node Success: "</span> + node);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    LoggerUtil.error(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" destroy Error"</span>, t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们需要实现自己的Export或者Referer，我们继承AbstractProtocol这个方法覆盖里面的两个抽象方法就好了。</p>
<p>比如说，我们希望motan支持protobuf或者thrift，那么我们继承AbstractProtocol这个抽象类，分别实现createExporter，createReferer方法。</p>
<p>那么这两个方法怎么实现呢？</p>
<p>我们来看motan给出的一个默认实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpiMeta</span>(name = <span class="string">"motan"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcProtocol</span> <span class="keyword">extends</span> <span class="title">AbstractProtocol</span> </span>&#123;</div><div class="line">    <span class="comment">// 多个service可能在相同端口进行服务暴露，因此来自同个端口的请求需要进行路由以找到相应的服务，同时不在该端口暴露的服务不应该被找到</span></div><div class="line">    <span class="comment">// ProviderMessageRouter负责了服务端消息的路由调用，同时也负责了心跳的逻辑</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, ProviderMessageRouter&gt; ipPort2RequestRouter = <span class="keyword">new</span> HashMap&lt;String, ProviderMessageRouter&gt;();</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">createExporter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultRpcExporter&lt;T&gt;(provider, url);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">Referer&lt;T&gt; <span class="title">createReferer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultRpcReferer&lt;T&gt;(clz, url, serviceUrl);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * rpc provider</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@author</span> maijunsheng</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcExporter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractExporter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> Server server;</div><div class="line">        <span class="keyword">private</span> EndpointFactory endpointFactory;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DefaultRpcExporter</span><span class="params">(Provider&lt;T&gt; provider, URL url)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(provider, url);</div><div class="line">            ProviderMessageRouter requestRouter = initRequestRouter(url);</div><div class="line">            endpointFactory =</div><div class="line">                    ExtensionLoader.getExtensionLoader(EndpointFactory.class).getExtension(</div><div class="line">                            url.getParameter(URLParamType.endpointFactory.getName(), URLParamType.endpointFactory.getValue()));</div><div class="line">            <span class="comment">//创建server，目前motan仅实现了NettyServer（ExtensionLoader出现代表是可以扩展的，可以扩展自己的server）</span></div><div class="line">            server = endpointFactory.createServer(url, requestRouter);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>&#123;</div><div class="line">            String protocolKey = MotanFrameworkUtil.getProtocolKey(url);</div><div class="line">            String ipPort = url.getServerPortStr();</div><div class="line">            Exporter&lt;T&gt; exporter = (Exporter&lt;T&gt;) exporterMap.remove(protocolKey);</div><div class="line">            <span class="keyword">if</span> (exporter != <span class="keyword">null</span>) &#123;</div><div class="line">                exporter.destroy();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">synchronized</span> (ipPort2RequestRouter) &#123;</div><div class="line">                ProviderMessageRouter requestRouter = ipPort2RequestRouter.get(ipPort);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (requestRouter != <span class="keyword">null</span>) &#123;</div><div class="line">                    requestRouter.removeProvider(provider);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            LoggerUtil.info(<span class="string">"DefaultRpcExporter unexport Success: url=&#123;&#125;"</span>, url);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="comment">//打开服务，</span></div><div class="line">            <span class="keyword">boolean</span> result = server.open();</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> server.isAvailable();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">            endpointFactory.safeReleaseResource(server, url);</div><div class="line">            LoggerUtil.info(<span class="string">"DefaultRpcExporter destory Success: url=&#123;&#125;"</span>, url);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">private</span> ProviderMessageRouter <span class="title">initRequestRouter</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">            ProviderMessageRouter requestRouter = <span class="keyword">null</span>;</div><div class="line">            String ipPort = url.getServerPortStr();</div><div class="line">            <span class="keyword">synchronized</span> (ipPort2RequestRouter) &#123;</div><div class="line">                requestRouter = ipPort2RequestRouter.get(ipPort);</div><div class="line">                <span class="keyword">if</span> (requestRouter == <span class="keyword">null</span>) &#123;</div><div class="line">                    requestRouter = <span class="keyword">new</span> ProviderProtectedMessageRouter(provider);</div><div class="line">                    ipPort2RequestRouter.put(ipPort, requestRouter);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    requestRouter.addProvider(provider);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> requestRouter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * rpc referer</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     * <span class="doctag">@author</span> maijunsheng</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcReferer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractReferer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> Client client;</div><div class="line">        <span class="keyword">private</span> EndpointFactory endpointFactory;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DefaultRpcReferer</span><span class="params">(Class&lt;T&gt; clz, URL url, URL serviceUrl)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(clz, url, serviceUrl);</div><div class="line"></div><div class="line">            endpointFactory =</div><div class="line">                    ExtensionLoader.getExtensionLoader(EndpointFactory.class).getExtension(</div><div class="line">                            url.getParameter(URLParamType.endpointFactory.getName(), URLParamType.endpointFactory.getValue()));</div><div class="line">            <span class="comment">// 创建client</span></div><div class="line">            client = endpointFactory.createClient(url);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 用这个协议的服务，每次调用必经过这个方法</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Response <span class="title">doCall</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 为了能够实现跨group请求，需要使用server端的group。</span></div><div class="line">                request.setAttachment(URLParamType.group.getName(), serviceUrl.getGroup());</div><div class="line">                <span class="keyword">return</span> client.request(request);</div><div class="line">            &#125; <span class="keyword">catch</span> (TransportException exception) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="string">"DefaultRpcReferer call Error: url="</span> + url.getUri(), exception);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decrActiveCount</span><span class="params">(Request request, Response response)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (response == <span class="keyword">null</span> || !(response <span class="keyword">instanceof</span> Future)) &#123;</div><div class="line">                activeRefererCount.decrementAndGet();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            Future future = (Future) response;</div><div class="line">            future.addListener(<span class="keyword">new</span> FutureListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    activeRefererCount.decrementAndGet();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// 打开client</span></div><div class="line">            <span class="keyword">boolean</span> result = client.open();</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> client.isAvailable();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">            endpointFactory.safeReleaseResource(client, url);</div><div class="line">            LoggerUtil.info(<span class="string">"DefaultRpcReferer destory client: url=&#123;&#125;"</span> + url);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ProviderMessageRouter：这个类也比较核心，call方法处理了Server消息路由调用的逻辑，handle方法理了心跳的逻辑</p>
<hr>
<p>后记：看到这里，觉得motan真心不错，虽然功能算不上丰富，但是处处留了扩展的入口。所以还在纠结要不要用motan的可以不用纠结了，即便你需要的功能motan没有覆盖到，<br>但是你多半也可以扩展去改造它。</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-20-motan-loadbalance.html" >
  Motan源码解读-负载均衡
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-20-motan-loadbalance.html"><span class="article-date">
  2016-09-20
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <h4 id="负载均衡的策略"><a href="#负载均衡的策略" class="headerlink" title="负载均衡的策略"></a>负载均衡的策略</h4><blockquote>
<p>Motan 在集群负载均衡时，提供了多种方案，缺省为 ActiveWeight，并支持自定义扩展。 负载均衡策略在Client端生效，因此需在Client端添加配置</p>
</blockquote>
<p><strong>目前支持的负载均衡策略有：</strong></p>
<ul>
<li>ActiveWeight(缺省)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;activeWeight&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>低并发度优先： referer 的某时刻的 call 数越小优先级越高<br>由于 Referer List 可能很多，比如上百台，如果每次都要从这上百个 Referer 或者最低并发的几个，性能有些损耗，因此 random.nextInt(list.size()) 获取一个起始的 index，然后获取最多不超过 MAX_REFERER_COUNT 的状态是 isAvailable 的 referer 进行判断 activeCount.</p>
</blockquote>
<ul>
<li>Random</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;random&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>随机，按权重设置随机概率。<br>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</p>
</blockquote>
<ul>
<li>RoundRobin</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;roundrobin&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>轮循，按公约后的权重设置轮循比率</p>
</blockquote>
<ul>
<li>LocalFirst</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;localFirst&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>本地服务优先获取策略，对referers根据ip顺序查找本地服务，多存在多个本地服务，获取Active最小的本地服务进行服务。<br>当不存在本地服务，但是存在远程RPC服务，则根据ActivWeight获取远程RPC服务<br>当两者都存在，所有本地服务都应优先于远程服务，本地RPC服务与远程RPC服务内部则根据ActiveWeight进行</p>
</blockquote>
<ul>
<li>Consistent</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;consistent&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>一致性 Hash，相同参数的请求总是发到同一提供者</p>
</blockquote>
<ul>
<li>ConfigurableWeight</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;motan:protocol ... loadbalance=&quot;configurableWeight&quot;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>权重可配置的负载均衡策略</p>
</blockquote>
<h4 id="motan加载loadbalance策略的机制"><a href="#motan加载loadbalance策略的机制" class="headerlink" title="motan加载loadbalance策略的机制"></a>motan加载loadbalance策略的机制</h4><p>上面我们了解了motan支持的负载均衡的策略，下面我们来剖析一下motan怎么实现的。</p>
<p>RPCClient首先会经过一层HA（这里 motan实现了两种容灾策略，failfast&amp;failover），然后会根据配置的loadbalance的策略选取相应的nettyClient发送请求到RPCServer。流程如下图所示：</p>
<p><img src="/images/motan/14612385789967.jpg" alt=""></p>
<p>motan的loadbalance策略实现在客户端，客户端初始化时会根据配置，基于spi机制查找对应的实现（不了解SPI的可以看<a href="http://zhizus.com/code/motan-spi" target="_blank" rel="external">Motan源码解读-SPI机制</a>加载loadbalance的实现。<br>调用链如下图所示：</p>
<p><img src="/images/motan/motan-lb.png" alt=""></p>
<h4 id="motan-LoadBalance实现"><a href="#motan-LoadBalance实现" class="headerlink" title="motan LoadBalance实现"></a>motan LoadBalance实现</h4><p><img src="/images/motan/loadbalance.png" alt=""></p>
<p>接下来，我们看loadbalance接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以基于SPI扩展，使用方可以实现自己的LoadBalance</span></div><div class="line"><span class="meta">@Spi</span>(scope = Scope.PROTOTYPE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoadBalance</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//当可用的应用列表变化时会调用这个方法刷新（motan的可用引用列表是基于服务发现这种模式实现，目前实现了consul&amp;zk）</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(List&lt;Referer&lt;T&gt;&gt; referers)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 基于负载均衡的策略选择可用的引用</span></div><div class="line">    <span class="function">Referer&lt;T&gt; <span class="title">select</span><span class="params">(Request request)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// FailoverHaStrategy会使用到这个，多线程场景</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">selectToHolder</span><span class="params">(Request request, List&lt;Referer&lt;T&gt;&gt; refersHolder)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// ?? 仅仅属于WeightLoadBalance的特性，定义在最上层接口是否合适？？</span></div><div class="line">    <span class="comment">//cluster.getLoadBalance().setWeightString(weights); 这里使用的时候判断一下类型，对WeightLoadBalance这种类型单独处理向下转型是否可以？</span></div><div class="line">    <span class="comment">// 或者是否有其他更好的办法？？</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setWeightString</span><span class="params">(String weightString)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们AbstractLoadBalance,实现了公有的基础逻辑。将不同的策略交由子类去实现，实际上应用到了java设计模式的模板模式。</p>
<blockquote>
<p>模板模式在模板模式（Template Pattern）中，一个抽象类公开定义了执行它的方法的方式/模板。它的子类可以按需要重写方法实现，但调用将以抽象类中定义的方式进行。这种类型的设计模式属于行为型模式。</p>
</blockquote>
<p>下面我们看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLoadBalance</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">LoadBalance</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Referer&lt;T&gt;&gt; referers;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(List&lt;Referer&lt;T&gt;&gt; referers)</span> </span>&#123;</div><div class="line">        <span class="comment">// 只能引用替换，不能进行referers update。</span></div><div class="line">        <span class="keyword">this</span>.referers = referers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Referer&lt;T&gt; <span class="title">select</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = <span class="keyword">this</span>.referers;</div><div class="line"></div><div class="line">        Referer&lt;T&gt; ref = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (referers.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">            ref = doSelect(request);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (referers.size() == <span class="number">1</span>) &#123;</div><div class="line">            ref = referers.get(<span class="number">0</span>).isAvailable() ? referers.get(<span class="number">0</span>) : <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> ref;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" No available referers for call request:"</span> + request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectToHolder</span><span class="params">(Request request, List&lt;Referer&lt;T&gt;&gt; refersHolder)</span> </span>&#123;</div><div class="line">        List&lt;Referer&lt;T&gt;&gt; referers = <span class="keyword">this</span>.referers;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (referers == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" No available referers for call : referers_size= 0 "</span></div><div class="line">                    + MotanFrameworkUtil.toString(request));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (referers.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">            doSelectToHolder(request, refersHolder);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (referers.size() == <span class="number">1</span> &amp;&amp; referers.get(<span class="number">0</span>).isAvailable()) &#123;</div><div class="line">            refersHolder.add(referers.get(<span class="number">0</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (refersHolder.isEmpty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" No available referers for call : referers_size="</span></div><div class="line">                    + referers.size() + <span class="string">" "</span> + MotanFrameworkUtil.toString(request));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> List&lt;Referer&lt;T&gt;&gt; getReferers() &#123;</div><div class="line">        <span class="keyword">return</span> referers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWeightString</span><span class="params">(String weightString)</span> </span>&#123;</div><div class="line">        LoggerUtil.info(<span class="string">"ignore weightString:"</span> + weightString);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Referer&lt;T&gt; <span class="title">doSelect</span><span class="params">(Request request)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doSelectToHolder</span><span class="params">(Request request, List&lt;Referer&lt;T&gt;&gt; refersHolder)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>子类重写<code>doSelect(Request request)</code>方法就是实现自己的策略。(里面还有一个doSelectToHolder(Request request, List<referer<t>&gt; refersHolder)方法，这个FailoverHaStrategy会涉及到，我们下一篇在讨论)</referer<t></p>
<p>看了一遍各种策略具体实现，貌似没什么好说的。有兴趣可以直接看motan源代码。</p>
<p>下面贴出一个另外一种的实现，仅供学习参考，<code>非线程安全</code>，使用时需要注意.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalance</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cw = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] weight;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadBalance</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.count = count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadBalance</span><span class="params">(<span class="keyword">int</span>[] weight)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.count = weight.length;</div><div class="line">        <span class="keyword">this</span>.weight = weight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashIndex</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> hash = <span class="number">5381L</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> index;</div><div class="line">        <span class="keyword">for</span>(index = <span class="number">0</span>; index &lt; key.length(); ++index) &#123;</div><div class="line">            hash = (hash &lt;&lt; <span class="number">5</span>) + hash + (<span class="keyword">long</span>)key.charAt(index);</div><div class="line">            hash &amp;= <span class="number">4294967295L</span>;</div><div class="line">        &#125;</div><div class="line">        index = (<span class="keyword">int</span>)hash % <span class="keyword">this</span>.count;</div><div class="line">        index = Math.abs(index);</div><div class="line">        <span class="keyword">return</span> index;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">roundIndexByWeight</span><span class="params">()</span> </span>&#123;</div><div class="line">        do &#123;</div><div class="line">            <span class="keyword">this</span>.i = (<span class="keyword">this</span>.i + <span class="number">1</span>) % <span class="keyword">this</span>.count;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.i == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">this</span>.cw -= <span class="keyword">this</span>.gcd();</div><div class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.cw &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.cw = <span class="keyword">this</span>.max();</div><div class="line">                    <span class="keyword">if</span>(<span class="keyword">this</span>.cw == <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">while</span>(<span class="keyword">this</span>.weight[<span class="keyword">this</span>.i] &lt; <span class="keyword">this</span>.cw);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.i;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">roundIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> j = <span class="keyword">this</span>.i;</div><div class="line">        j = (j + <span class="number">1</span>) % <span class="keyword">this</span>.count;</div><div class="line">        <span class="keyword">this</span>.i = j;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.i;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">gcd</span><span class="params">()</span> </span>&#123;</div><div class="line">        BigInteger value = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.weight.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            value = BigInteger.valueOf((<span class="keyword">long</span>)<span class="keyword">this</span>.weight[<span class="keyword">this</span>.i]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.weight.length - <span class="number">1</span>; ++i) &#123;</div><div class="line">            BigInteger tmp = BigInteger.valueOf((<span class="keyword">long</span>)<span class="keyword">this</span>.weight[i]);</div><div class="line">            tmp = tmp.gcd(BigInteger.valueOf((<span class="keyword">long</span>)<span class="keyword">this</span>.weight[i + <span class="number">1</span>]));</div><div class="line">            <span class="keyword">if</span>(value.compareTo(tmp) &gt; <span class="number">0</span>) &#123;</div><div class="line">                value = tmp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != value) &#123;</div><div class="line">            <span class="keyword">return</span> value.intValue();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">max</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.weight.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            value = <span class="keyword">this</span>.weight[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.weight.length - <span class="number">1</span>; ++i) &#123;</div><div class="line">            <span class="keyword">int</span> tmp = <span class="keyword">this</span>.weight[i];</div><div class="line">            <span class="keyword">if</span>(value &lt; tmp) &#123;</div><div class="line">                value = tmp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HALBProxy</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> HALBProxy.Strategy strategy;</div><div class="line">    <span class="keyword">private</span> LoadBalance lb;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HALBProxy</span><span class="params">(HALBProxy.Strategy strategy)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.logger = Logger.getLogger(<span class="keyword">this</span>.getClass());</div><div class="line">        <span class="keyword">this</span>.availServers = <span class="keyword">new</span> CopyOnWriteArrayList();</div><div class="line">        <span class="keyword">this</span>.unavailServers = <span class="keyword">new</span> CopyOnWriteArrayList();</div><div class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> HashSet();</div><div class="line">        <span class="keyword">this</span>.strategy = strategy;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span>(strategy) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.lb.roundIndex();</div><div class="line">        <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.lb.roundIndexByWeight();</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.lb.hashIndex(key);</div><div class="line">    &#125;</div><div class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> Strategy &#123;</div><div class="line">        DEFAULT,</div><div class="line">        RR,</div><div class="line">        WRR,</div><div class="line">        HASH;</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Strategy</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>总的来说负载均衡部分还算比较简单，LocalFirst优先读取本机的服务这个策略还是很不错的。</p>
<hr>
<p>关于更多loadbalance请看<a href="http://tutorials.jenkov.com/software-architecture/load-balancing.html" target="_blank" rel="external">老外的文章(直戳loadbalance本质)</a></p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-19-motan-spi.html" >
  Motan源码解读-SPI机制
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-19-motan-spi.html"><span class="article-date">
  2016-09-19
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <p>SPI 全称为 (Service Provider Interface) ,是JDK内置的一种服务提供发现机制。<br>motan（也包括dubbo）各个模块的扩展都是基于spi来实现了，学习了解SPI机制对motan的学习尤为重要。</p>
<h3 id="SPI机制"><a href="#SPI机制" class="headerlink" title="SPI机制"></a>SPI机制</h3><p>SPI的全名为Service Provider Interface.大多数开发人员可能不熟悉，因为这个是针对厂商或者插件的。在java.util.ServiceLoader的文档里有比较详细的介绍。简单的总结下java spi机制的思想。我们系统里抽象的各个模块，往往有很多不同的实现方案，比如日志模块的方案，xml解析模块、jdbc模块的方案等。面向的对象的设计里，我们一般推荐模块之间基于接口编程，模块之间不对实现类进行硬编码。一旦代码里涉及具体的实现类，就违反了可拔插的原则，如果需要替换一种实现，就需要修改代码。为了实现在模块装配的时候能不在程序里动态指明，这就需要一种服务发现机制。 java spi就是提供这样的一个机制：为某个接口寻找服务实现的机制。有点类似IOC的思想，就是将装配的控制权移到程序之外，在模块化设计中这个机制尤其重要。</p>
<h3 id="SPI约定"><a href="#SPI约定" class="headerlink" title="SPI约定"></a>SPI约定</h3><p>java spi的具体约定为:当服务的提供者，提供了服务接口的一种实现之后，在jar包的META-INF/services/目录里同时创建一个以服务接口命名的文件。该文件里就是实现该服务接口的具体实现类。而当外部程序装配这个模块的时候，就能通过该jar包META-INF/services/里的配置文件找到具体的实现类名，并装载实例化，完成模块的注入。 基于这样一个约定就能很好的找到服务接口的实现类，而不需要再代码里制定。jdk提供服务实现查找的一个工具类：java.util.ServiceLoader</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><strong>common-logging</strong><br>apache最早提供的日志的门面接口。只有接口，没有实现。具体方案由各提供商实现， 发现日志提供商是通过扫描 META-INF/services/org.apache.commons.logging.LogFactory配置文件，通过读取该文件的内容找到日志提工商实现类。只要我们的日志实现里包含了这个文件，并在文件里制定 LogFactory工厂接口的实现类即可。</li>
<li><p><strong>jdbc</strong><br>jdbc4.0以前， 开发人员还需要基于Class.forName(“xxx”)的方式来装载驱动，jdbc4也基于spi的机制来发现驱动提供商了，可以通过META-INF/services/java.sql.Driver文件里指定实现类的方式来暴露驱动提供者。</p>
</li>
<li><p><strong>dubbo&amp;motan</strong><br>dubbo和motan也扩展了spi作为框架的主要扩展机制。</p>
</li>
</ul>
<h3 id="使用示例："><a href="#使用示例：" class="headerlink" title="使用示例："></a>使用示例：</h3><p>接口定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">package my.xyz.spi;  </div><div class="line">import java.util.List;  </div><div class="line">public interface Search &#123;  </div><div class="line">   public List serch(String keyword);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>A公司采用文件系统搜索的方式实现了 Search接口，B公司采用了数据库系统的方式实现了Search接口</p>
<ul>
<li>A公司实现的类  com.A.spi.impl.FileSearch  </li>
<li>B公司实现的类  com.B.spi.impl.DatabaseSearch  </li>
</ul>
<p>那么A公司发布 实现jar包时，则要在jar包中META-INF/services/my.xyz.spi.Search文件中写下如下内容<br>    com.A.spi.impl.FileSearch<br>那么B公司发布 实现jar包时，则要在jar包中META-INF/services/my.xyz.spi.Search文件中写下如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"> com.B.spi.impl.DatabaseSearch</div><div class="line">package com.xyz.factory;  </div><div class="line">import java.util.Iterator;  </div><div class="line">import java.util.ServiceLoader;  </div><div class="line">import my.xyz.spi.Search;  </div><div class="line">public class SearchFactory &#123;  </div><div class="line">    private SearchFactory() &#123;  </div><div class="line">    &#125;  </div><div class="line">    public static Search newSearch() &#123;  </div><div class="line">        Search search = null;  </div><div class="line">        ServiceLoader&lt;Search&gt; serviceLoader = ServiceLoader.load(Search.class);  </div><div class="line">        Iterator&lt;Search&gt; searchs = serviceLoader.iterator();  </div><div class="line">        if (searchs.hasNext()) &#123;  </div><div class="line">            search = searchs.next();  </div><div class="line">        &#125;  </div><div class="line">        return search;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package my.xyz.test;  </div><div class="line">import java.util.Iterator;  </div><div class="line">import java.util.ServiceLoader;  </div><div class="line">import com.xyz.factory.SearchFactory;  </div><div class="line">import my.xyz.spi.Search;  </div><div class="line">public class SearchTest &#123;  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">        Search search = SearchFactory.newSearch();  </div><div class="line">        search.serch(&quot;java spi test&quot;);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="JDK-SPI"><a href="#JDK-SPI" class="headerlink" title="JDK SPI"></a>JDK SPI</h4><p><strong>JDK自带的ServiceLoader功能比较弱，只提供了如下几个方法：</strong></p>
<ul>
<li><p>reload：清除服务实例缓存，重新加载；</p>
</li>
<li><p>iterator:延迟方式加载服务，按配置的顺序生成服务实例；</p>
</li>
<li><p>load：从上下文加载器（ContextClassLoader）加载。</p>
</li>
<li><p>loadInstalled，系统加载器（SystemClassLoader）优先，没有则从上下文加载器加载。</p>
</li>
</ul>
<p>实际上，JDK自带的ServiceLoader并不能满足开发的需求，例如单例服务，按别名使用指定的服务实现，优先级控制等等。</p>
<h4 id="Motan-SPI"><a href="#Motan-SPI" class="headerlink" title="Motan SPI"></a>Motan SPI</h4><p>Motan底层模块之间调用也是采用SPI模式（com.weibo.api.motan.core.extension.ExtensionLoader），可以根据配置实现调用不同的服务实例。</p>
<p><strong>Motan提供了三个注解：</strong></p>
<p><code>@Spi</code> 声明接口为SPI服务接口；</p>
<p><code>@Scope</code> 声明单例模式还是多例模式</p>
<p><code>@Activation</code> 声明服务优先级（sequence值越小越优先调用）、分组查询、以及是否支持重试调用。</p>
<p><code>@SpiMeta</code>设定服务别名，没配置则用实现类的类名为别名</p>
<p>ExtensionLoader兼容JDK自带的ServiceLoader，也就是说跟ServiceLoader的配置方式是一样的，在META-INF/services创建服务接口文件，内容为实现类的完整包路径列表。</p>
<p>实现：<br>ClassLoader.getSystemResources(“”)根据路径获取所有加载的URL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Enumeration&lt;URL&gt; urls = ClassLoader.getSystemResources(&quot;META-INF/services/com.dempe.spi.Search&quot;);</div></pre></td></tr></table></figure>
<p>基于上面的注解扩展SPI的语义已经很清晰了，暂时不再深入研究。如果兴趣可co下来淘宝的<a href="https://github.com/alibaba/cooma/wiki" target="_blank" rel="external">Cooma</a>  (Cooma是一个极简、灵活的开源Java微容器（microcontainer）实现。)</p>
<h4 id="motan的扩展"><a href="#motan的扩展" class="headerlink" title="motan的扩展"></a>motan的扩展</h4><p>motan是一个轻量的RPC框架，同时motan的扩展性也是非常好的，你几乎可以扩展它实现任何你希望RPC框架可以有的能力。</p>
<p>我们大致看看包含SPI注解的类：</p>
<p><img src="/images/motan/SPI.png" alt="Alt text"></p>
<p>我们可以看到基本上在任何地方我们能想到扩展的地方motan都给我们留下了扩展的入口。</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016-09-19-motan-clientMessage.html" >
  Motan源码解读-Client异步消息
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016-09-19-motan-clientMessage.html"><span class="article-date">
  2016-09-19
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Motan源码解读/">Motan源码解读</a></li></ul>
	</span>


        

      </div>
      <div class="article-entry">
        
          <h3 id="如何设计RPC异步消息？"><a href="#如何设计RPC异步消息？" class="headerlink" title="如何设计RPC异步消息？"></a>如何设计RPC异步消息？</h3><p>异步调用的好处就不说了，我们直入主题，讨论RPC异步消息如何设计？</p>
<p>既然是异步的，我们有一个首要的问题需要解决：</p>
<blockquote>
<p>通常异步调用都是一问一答的模式，一个Request拿到一个Response，如果我们做了异步，怎么把这两个消息对应起来呢？</p>
</blockquote>
<p>既然需要对应，那么只有一种思路就是通过一种方式把两者联系起来，所以我们在设计协议的时候必须包含一个messageID，唯一的，这个唯一性是在客户端维护（多是自增）。</p>
<p>客户端发送请求的req的时候，先req.setMessageId(messageID)，然后在发送；服务端拿到这个messageID的时候，把messageID原封不动的包装在Response中，这样客户端就可以把request和response对应起来。</p>
<h3 id="纸上得来终觉浅，我们试着来撸一个"><a href="#纸上得来终觉浅，我们试着来撸一个" class="headerlink" title="纸上得来终觉浅，我们试着来撸一个"></a>纸上得来终觉浅，我们试着来撸一个</h3><p>我们写一个简单的DefaultClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> Map&lt;Integer, Context&gt; contextMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, Context&gt;();</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initClientChannel</span><span class="params">(SocketChannel ch)</span> </span>&#123;</div><div class="line">        ChannelPipeline pipeline = ch.pipeline();</div><div class="line">        pipeline.</div><div class="line">                .addLast(<span class="string">"ClientHandler"</span>, <span class="keyword">new</span> ChannelHandlerAdapter() &#123;</div><div class="line">                    <span class="comment">/**</span></div><div class="line">                    * 收到服务端消息</div><div class="line">                    **/</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Response resp)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    </div><div class="line">                        <span class="comment">// 收到服务端消息，找出对应包含context的request上下文，然后移除</span></div><div class="line">                        Context context = contextMap.remove(id);</div><div class="line">                        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</div><div class="line">                            LOGGER.debug(<span class="string">"messageID:&#123;&#125;, take Context null"</span>, id);</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//异步通知结果返回</span></div><div class="line">                        context.cb.onReceive(resp);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 发送消息，并等待Response</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@return</span> Response</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Callback <span class="title">call</span><span class="params">(Request request, Callback callback)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">int</span> id = getNextMessageId();</div><div class="line">        request.setMessageID(id);</div><div class="line">        Context context = <span class="keyword">new</span> Context(id, request, callback);</div><div class="line">        <span class="comment">// 发送消息前先把request上下文保存起来，</span></div><div class="line">        contextMap.put(id, context);</div><div class="line">        writeAndFlush(request);</div><div class="line">        <span class="comment">// 消息发送出去就直接返回callback，不会阻塞等待服务端结果返回</span></div><div class="line">        <span class="comment">// 当客户端收到服务端返回的response首先会通过messageID找到对应的request上下文，然后调用callback的onReceive(resp)方法通知</span></div><div class="line">        <span class="keyword">return</span> callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Future&lt;Response&gt; <span class="title">send</span><span class="params">(Request request)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Promise&lt;Response&gt; future = <span class="keyword">new</span> Promise&lt;Response&gt;();</div><div class="line">        call(request, future);</div><div class="line">        <span class="keyword">return</span> future;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">sendAnWait</span><span class="params">(Request request)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Future&lt;Response&gt; future = send(request);</div><div class="line">        <span class="keyword">return</span> future.await();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">sendAnWait</span><span class="params">(Request request, <span class="keyword">long</span> amount, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Future&lt;Response&gt; future = send(request);</div><div class="line">        <span class="keyword">return</span> future.await(amount, unit);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Request request;</div><div class="line">        <span class="keyword">final</span> Callback cb;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">short</span> id;</div><div class="line"></div><div class="line">        Context(<span class="keyword">short</span> id, Request request, Callback cb) &#123;</div><div class="line">            <span class="keyword">this</span>.id = id;</div><div class="line">            <span class="keyword">this</span>.cb = cb;</div><div class="line">            <span class="keyword">this</span>.request = request;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DefaultClient做的事情就是在发送Request消息时候先保存request的上下文，等到服务端消息返回，然后通过callback异步通知。<br>接下来我们要看看callback的实现了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Promise</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Callback</span>&lt;<span class="title">T</span>&gt;, <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">    Throwable error;</div><div class="line">    <span class="keyword">private</span> T message;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(T message)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.message = message;</div><div class="line">            latch.countDown();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 当onReceive调用之前，await方法会阻塞，一直到timeout</span></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">await</span><span class="params">(<span class="keyword">long</span> amount, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (latch.await(amount, unit)) &#123;</div><div class="line">            <span class="keyword">return</span> get();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        latch.await();</div><div class="line">        <span class="keyword">return</span> get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Throwable e = error;</div><div class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">                <span class="keyword">throw</span> (RuntimeException) e;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Exception) &#123;</div><div class="line">                <span class="keyword">throw</span> (Exception) e;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">                <span class="keyword">throw</span> (Error) e;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// don'M expect to hit this case.</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> message;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>利用java的CountDownLatch可以非常轻松的实现：当回调方法调用之前，获取结果的await方法一直阻塞的。</p>
<p>到此为止，我们基本实现异步消息调用的核心<code>伪代码</code>，但是是不是万事大吉了呢？</p>
<h3 id="But，还有一个大bug"><a href="#But，还有一个大bug" class="headerlink" title="But，还有一个大bug"></a>But，还有一个大bug</h3><p>还有什么问题？</p>
<blockquote>
<p>服务端异常状态没有机制返回给客户端？</p>
</blockquote>
<p>当然这个也是一个很严重的问题，但是只能算是一个需要优化的地方，并不是下面要说的大bug。</p>
<p><strong>我们思考一下下面的问题：</strong></p>
<ul>
<li>1.客户端发送异常的时候，contextMap中存储的Request上下文如何回收？</li>
<li>2.服务端超时或者异常情况，contextMap又如何回收？</li>
</ul>
<p>问题1很要解决，在发送的时候捕获一下发送的异常，出现异常主动将contextMap的对象移除。伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Callback <span class="title">call</span><span class="params">(Request request, Callback callback)</span>  </span>&#123;</div><div class="line">    <span class="keyword">int</span> id = getNextMessageId();</div><div class="line">    request.setMessageID(id);</div><div class="line">    Context context = <span class="keyword">new</span> Context(id, request, callback);</div><div class="line">    <span class="comment">// 发送消息前先把request上下文保存起来，</span></div><div class="line">    contextMap.put(id, context);</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">         writeAndFlush(request);</div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">         contextMap.remove(id);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 消息发送出去就直接返回callback，不会阻塞等待服务端结果返回</span></div><div class="line">    <span class="comment">// 当客户端收到服务端返回的response首先会通过messageID找到对应的request上下文，然后调用callback的onReceive(resp)方法通知</span></div><div class="line">    <span class="keyword">return</span> callback;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关键是问题2，服务端超时，或者异常，这时候客户端收不到任何消息，那么上面的代码中contextMap的request上下文就没办法清理掉。</p>
<p>这个时候该如何处理呢？<br>我们先讨论RPC一个很重的点：<code>TimeOut机制</code>。<br>如果没有timeout，假设某个服务响应慢或者不可用，可能造成客户端所有的connection都在等待请求响应，其他可用的服务也无法提供服务。<br>客户端请求分配的资源是有限的，我们不能因为某个业务不可用或者响应慢而让他占用了所有的资源。<code>对于每个异步调用的请求，我们最好都能给他一个默认的超时时间</code>。</p>
<p>既然RPC有timeout机制，那么处理问题2最自然的思路就是定时去扫描contextMap，将里面超时的context清理掉。<code>motan也是这么做的</code></p>
<p>不过，我们还有其他的办法：</p>
<p>我们在客户端发送请求前，先通过<code>timer.newTimeout(new ClearContextMapTask(){},....)</code>,等到这个连接超时，就会自动执行这个ClearContextMapTask，clean对应的超时request上下文。<br>这个还没完，因为很多时候，消息能够正常返回，<code>正常返回的时候我们主动将这个任务cancel掉</code>。</p>
<p>具体的实现可以参考<a href="https://github.com/Baidu-ecom/Jprotobuf-rpc-socket，（貌似是百度出品，代码质量还是有保障的）" target="_blank" rel="external">https://github.com/Baidu-ecom/Jprotobuf-rpc-socket，（貌似是百度出品，代码质量还是有保障的）</a></p>
<p>这个不是本文的重点，暂不详细展开。</p>
<h3 id="言归正传，我们来说Motan怎么实现"><a href="#言归正传，我们来说Motan怎么实现" class="headerlink" title="言归正传，我们来说Motan怎么实现"></a>言归正传，我们来说Motan怎么实现</h3><p>上面说了一堆，貌似跑题了，不过接下来，我们来剖析Motan 的源代码，看Motan是怎么实现这个逻辑的。</p>
<p>直接看源代码，（为了简洁，略掉不相关逻辑代码）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> <span class="keyword">extends</span> <span class="title">AbstractPoolClient</span> <span class="keyword">implements</span> <span class="title">StatisticCallback</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 回收过期任务</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ScheduledExecutorService scheduledExecutor = Executors.newScheduledThreadPool(<span class="number">4</span>);</div><div class="line"></div><div class="line">	<span class="comment">// 异步的request，需要注册callback future</span></div><div class="line">	<span class="comment">// 触发remove的操作有： 1) service的返回结果处理。 2) timeout thread cancel</span></div><div class="line">	<span class="keyword">protected</span> ConcurrentMap&lt;Long, NettyResponseFuture&gt; callbackMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, NettyResponseFuture&gt;();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> ScheduledFuture&lt;?&gt; timeMonitorFuture = <span class="keyword">null</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">			timeMonitorFuture = scheduledExecutor.scheduleWithFixedDelay(</div><div class="line">				<span class="keyword">new</span> TimeoutMonitor(<span class="string">"timeout_monitor_"</span> + url.getHost() + <span class="string">"_"</span> + url.getPort()),</div><div class="line">				MotanConstants.NETTY_TIMEOUT_TIMER_PERIOD, MotanConstants.NETTY_TIMEOUT_TIMER_PERIOD,</div><div class="line">				TimeUnit.MILLISECONDS);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 请求remote service</div><div class="line">	 * </div><div class="line">	 * &lt;pre&gt;</div><div class="line">	 * 		1)  get connection from pool</div><div class="line">	 * 		2)  async requset</div><div class="line">	 * 		3)  return connection to pool</div><div class="line">	 * 		4)  check if async return response, true: return ResponseFuture;  false: return result</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> request</div><div class="line">	 * <span class="doctag">@param</span> async</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 * <span class="doctag">@throws</span> TransportException</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> Response <span class="title">request</span><span class="params">(Request request, <span class="keyword">boolean</span> async)</span> <span class="keyword">throws</span> TransportException </span>&#123;</div><div class="line">		...</div><div class="line">		<span class="comment">// async request</span></div><div class="line">		response = channel.request(request);</div><div class="line">		response = asyncResponse(response, async);</div><div class="line">		<span class="keyword">return</span> response;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 初始化 netty clientBootstrap</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClientBootstrap</span><span class="params">()</span> </span>&#123;</div><div class="line">		</div><div class="line">		bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</div><div class="line">			...</div><div class="line">			<span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">getPipeline</span><span class="params">()</span> </span>&#123;</div><div class="line">				ChannelPipeline pipeline = Channels.pipeline();</div><div class="line">				pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> NettyDecoder(codec, NettyClient.<span class="keyword">this</span>, maxContentLength));</div><div class="line">				pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> NettyEncoder(codec, NettyClient.<span class="keyword">this</span>));</div><div class="line">				pipeline.addLast(<span class="string">"handler"</span>, <span class="keyword">new</span> NettyChannelHandler(NettyClient.<span class="keyword">this</span>, <span class="keyword">new</span> MessageHandler() &#123;</div><div class="line">					<span class="meta">@Override</span></div><div class="line">					<span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(Channel channel, Object message)</span> </span>&#123;</div><div class="line">						Response response = (Response) message;</div><div class="line"></div><div class="line">						NettyResponseFuture responseFuture = NettyClient.<span class="keyword">this</span>.removeCallback(response.getRequestId());</div><div class="line"></div><div class="line">						<span class="keyword">if</span> (responseFuture == <span class="keyword">null</span>) &#123;</div><div class="line">							LoggerUtil.warn(</div><div class="line">									<span class="string">"NettyClient has response from server, but resonseFuture not exist,  requestId=&#123;&#125;"</span>,</div><div class="line">									response.getRequestId());</div><div class="line">							<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="keyword">if</span> (response.getException() != <span class="keyword">null</span>) &#123;</div><div class="line">							responseFuture.onFailure(response);</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							responseFuture.onSuccess(response);</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;));</div><div class="line">				<span class="keyword">return</span> pipeline;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 注册回调的resposne</div><div class="line">	 * </div><div class="line">	 * &lt;pre&gt;</div><div class="line">	 * </div><div class="line">	 * 		进行最大的请求并发数的控制，如果超过NETTY_CLIENT_MAX_REQUEST的话，那么throw reject exception</div><div class="line">	 * </div><div class="line">	 * &lt;/pre&gt;</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> MotanServiceException</div><div class="line">	 * <span class="doctag">@param</span> requestId</div><div class="line">	 * <span class="doctag">@param</span> nettyResponseFuture</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallback</span><span class="params">(<span class="keyword">long</span> requestId, NettyResponseFuture nettyResponseFuture)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.callbackMap.size() &gt;= MotanConstants.NETTY_CLIENT_MAX_REQUEST) &#123;</div><div class="line">			<span class="comment">// reject request, prevent from OutOfMemoryError</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MotanServiceException(<span class="string">"NettyClient over of max concurrent request, drop request, url: "</span></div><div class="line">					+ url.getUri() + <span class="string">" requestId="</span> + requestId, MotanErrorMsgConstant.SERVICE_REJECT);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.callbackMap.put(requestId, nettyResponseFuture);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 移除回调的response</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> requestId</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> NettyResponseFuture <span class="title">removeCallback</span><span class="params">(<span class="keyword">long</span> requestId)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> callbackMap.remove(requestId);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 回收超时任务</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@author</span> maijunsheng</div><div class="line">	 * </div><div class="line">	 */</div><div class="line">	<span class="class"><span class="keyword">class</span> <span class="title">TimeoutMonitor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> String name;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">TimeoutMonitor</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.name = name;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">long</span> currentTime = System.currentTimeMillis();</div><div class="line">			<span class="keyword">for</span> (Map.Entry&lt;Long, NettyResponseFuture&gt; entry : callbackMap.entrySet()) &#123;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					NettyResponseFuture future = entry.getValue();</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (future.getCreateTime() + future.getTimeout() &lt; currentTime) &#123;</div><div class="line">						<span class="comment">// timeout: remove from callback list, and then cancel</span></div><div class="line">						removeCallback(entry.getKey());</div><div class="line">						future.cancel();</div><div class="line">					&#125; </div><div class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">					LoggerUtil.error(</div><div class="line">							name + <span class="string">" clear timeout future Error: uri="</span> + url.getUri() + <span class="string">" requestId="</span> + entry.getKey(),</div><div class="line">							e);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个里面的callbackMap就是存储request上下文的map，（TimeoutMonitor就是清理超时的请求上下文的）发送request请求的时候会调用到下面的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">request</span><span class="params">(Request request)</span> <span class="keyword">throws</span> TransportException </span>&#123;</div><div class="line"> </div><div class="line">  ...</div><div class="line">	<span class="keyword">boolean</span> result = writeFuture.awaitUninterruptibly(timeout, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (result &amp;&amp; writeFuture.isSuccess()) &#123;</div><div class="line">		response.addListener(<span class="keyword">new</span> FutureListener() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">				<span class="keyword">if</span> (future.isSuccess() || (future.isDone() &amp;&amp; ExceptionUtil.isBizException(future.getException()))) &#123;</div><div class="line">					<span class="comment">// 成功的调用 </span></div><div class="line">					nettyClient.resetErrorCount();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// 失败的调用 </span></div><div class="line">					nettyClient.incrErrorCount();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		<span class="comment">// 如果正常情况，就直接返回response</span></div><div class="line">		<span class="keyword">return</span> response;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	writeFuture.cancel();</div><div class="line">	<span class="comment">// 异常情况 将任务移除</span></div><div class="line">	response = <span class="keyword">this</span>.nettyClient.removeCallback(request.getRequestId());</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">		response.cancel();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到在正常情况下会直接返回response，异常情况下则是直接调用removeCallback(request.getRequestId())清除了callbackMap中的无用request。<br>接下来我们看正常情况下，motan是在哪里清理callbackMap中内容的？<br>这个时候我们又需要回到上面的NettyClient中去看NettyChannelHandler了。<br>收到服务器的返回的response的时候会触发NettyChannelHandler的handle方法，而handle方法中首先就是:<br>通过消息id，移除callbackMap中的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NettyResponseFuture responseFuture = NettyClient.<span class="keyword">this</span>.removeCallback(response.getRequestId());</div></pre></td></tr></table></figure>
<p>最后，我们看NettyClient中的TimeoutMonitor,它所做的的事情就是定时清理callbackMap超时的request上下文,NettyClient在初始化的时候就初始化了这个timeoutMonitor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">			timeMonitorFuture = scheduledExecutor.scheduleWithFixedDelay(</div><div class="line">				<span class="keyword">new</span> TimeoutMonitor(<span class="string">"timeout_monitor_"</span> + url.getHost() + <span class="string">"_"</span> + url.getPort()),</div><div class="line">				MotanConstants.NETTY_TIMEOUT_TIMER_PERIOD, MotanConstants.NETTY_TIMEOUT_TIMER_PERIOD,</div><div class="line">				TimeUnit.MILLISECONDS);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>接下来我们总结一下motan中callbackMap的逻辑：</p>
<ul>
<li>client发送request前先将request register到callbackMap中，如果发送前连接异常，则直接remove掉。</li>
<li>客户端收到response后，根据requestId找到对应的request上下文，并移除callbackMap中的对应的对象</li>
<li>对于服务端超时或者其他异常，客户端收不到消息的情况，则通过TimeoutMonitor来定时扫描callbackMap来清理。</li>
</ul>
<p>到这里为止，我们还没讲到motan的异步通知是怎么实现的：<br>具体实现可以看callbackMap中的NettyResponseFuture对象，它并不是通过java中闭锁CountDownLatch实现，而是用原生的lock.wait(), lock.notifyAll();来实现的。并不算复杂。有兴趣可以直接看源代码。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>异步消息的重点就是在客户端维护一个唯一的消息id，发送前先建立一个消息id和请求request上下文的映射，然后发送request消息到服务端。等收到服务端的response消息后，通过之前建立的映射找到对应的request，并且通过异步地址通知对应request，收到返回消息。</p>
<p>这种要异步通知机制就涉及到<code>callback&amp;CountDownLatch</code>一些相关的知识。</p>
<p>但是要实现一个靠谱的RPC框架，<code>一定要注意存放消息id和请求Request上下文映射的map特殊情况的内存释放问题</code>。而且这个map最好是线程安全的，一般rpc都会用到多线程。</p>
<p>最后，还有值得关注的地方：</p>
<p>实现一个完善的RPC框架，<code>能否有效的各种情况的异常透传到客户端</code>还是一个很重要的议题（用过公司的某个rpc，不管什么异常都是TimeoutException，联调接口时，如果出问题只能跪求别人查日志…），虽然本文没有讨论，但是有兴趣的可以好好研究一下motan在这一块的设计。<br>不过后续可能也会写对应的文章，好好探讨rpc异常设计和传递。</p>

        
      </div>
    </div>

  



  <div class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/archives/2016/09/page/2/">2</a><a class="extend next" rel="next" href="/archives/2016/09/page/2/">Next</a>
  </div>




          <div class="main-footer">
  
    © 2017 郑大侠的博客 - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
